const adminState = {
    sessionId: null,
    startTime: Date.now(),
    mangaData: [],
    tags: [],
    namespaces: []
};
let currentMangaId = null;
let currentSelectedTags = []; // ‰∏ä‰º†Êº´ÁîªÊó∂ÁöÑÊ†áÁ≠æ

// ÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
let currentPage = 1;
let itemsPerPage = 10;
let totalPages = 1;
let totalItems = 0;
let currentSearch = '';

// ÊòæÁ§∫ÈÄöÁü•Ê∂àÊÅØ
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    if (notification) {
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
}

// ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
        element.style.display = 'block';
    }
}

// ÈöêËóèÈîôËØØ‰ø°ÊÅØ
function hideError(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'none';
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    checkLoginStatus();
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadManga();
        });
    }
    setupFileInputs();
    setupDragAndDrop();
    loadTagNamespaces();
    loadAllTags();

    // ÂàùÂßãÂåñÂàÜÈ°µ
    setTimeout(() => {
        if (document.getElementById('manga').classList.contains('active')) {
            loadMangaList(currentPage, currentSearch);
        }
    }, 100);

    // üëá Êñ∞Â¢ûÔºö‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÁªü‰∏ÄÂ§ÑÁêÜÊº´ÁîªÁÆ°ÁêÜÈ°µÁöÑÊìç‰ΩúÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    const mangaListContainer = document.getElementById('mangaList');
    if (mangaListContainer) {
        mangaListContainer.addEventListener('click', function(e) {
            const btn = e.target.closest('button');
            if (!btn) return;

            const mangaId = btn.dataset.mangaId;
            if (!mangaId) return;

            if (btn.classList.contains('btn-info')) {
                openEditMangaModal(mangaId);
            } else if (btn.classList.contains('btn-warning')) {
                const mangaTitle = btn.dataset.mangaTitle || 'Êú™Áü•Êº´Áîª';
                openChapterModal(mangaId, mangaTitle);
            } else if (btn.classList.contains('btn-danger')) {
                deleteManga(mangaId);
            }
        });
    }
});

// Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
async function checkLoginStatus() {
    try {
        const sessionId = localStorage.getItem('admin_session_id');
        if (!sessionId) {
            window.location.href = '/login.html';
            return false;
        }
        const response = await fetch('/api/auth/check', {
            headers: {
                'Authorization': `Bearer ${sessionId}`
            }
        });
        const result = await response.json();
        if (response.ok && result.authenticated) {
            adminState.sessionId = sessionId;
            showAdminDashboard();
            return true;
        } else {
            localStorage.removeItem('admin_session_id');
            window.location.href = '/login.html';
            return false;
        }
    } catch (error) {
        console.error('Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', error);
        showNotification('Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•', 'error');
        localStorage.removeItem('admin_session_id');
        window.location.href = '/login.html';
        return false;
    }
}

// ÊòæÁ§∫ÁÆ°ÁêÜÂêéÂè∞
function showAdminDashboard() {
    loadDashboardData();
    loadMangaList(currentPage, currentSearch);
}

// Âä†ËΩΩ‰ª™Ë°®ÊùøÊï∞ÊçÆ
async function loadDashboardData() {
    try {
        // Ëé∑ÂèñÊº´ÁîªÊÄªÊï∞
        const mangaCountResponse = await fetch('/api/manga?page=1&pageSize=1');
        const mangaCountData = await mangaCountResponse.json();
        const totalMangaCount = mangaCountData.total || 0;

        // Ëé∑Âèñ‰∏Ä‰∫õÊº´ÁîªÊï∞ÊçÆÁî®‰∫éÊúÄËøëÊ¥ªÂä®
        const mangaResponse = await fetch('/api/manga?page=1&pageSize=5');
        const mangaData = await mangaResponse.json();
        const mangaList = mangaData.data || [];

        const statsResponse = await fetch('/api/stats');
        const statsData = await statsResponse.json();

        // Êõ¥Êñ∞ÁªüËÆ°
        updateStatistics(totalMangaCount, statsData);
        updateRecentActivity(mangaList);
    } catch (error) {
        console.error('Âä†ËΩΩ‰ª™Ë°®ÊùøÊï∞ÊçÆÂ§±Ë¥•:', error);
        showNotification('Âä†ËΩΩ‰ª™Ë°®ÊùøÊï∞ÊçÆÂ§±Ë¥•', 'error');
    }
}

// Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØÂáΩÊï∞
function updateStatistics(totalMangaCount, statsData) {
    if (!statsData || typeof statsData !== 'object') statsData = {};

    // Êõ¥Êñ∞Êº´ÁîªÊÄªÊï∞
    const totalManga = document.getElementById('totalManga');
    if (totalManga) totalManga.textContent = totalMangaCount;

    // Êõ¥Êñ∞ËÆøÈóÆËÄÖÊï∞Èáè
    const totalVisitors = document.getElementById('totalVisitors');
    if (totalVisitors) {
        const visits = statsData.totalVisits || 0;
        totalVisitors.textContent = visits;
    }
}

// Êõ¥Êñ∞ÊúÄËøëÊ¥ªÂä®
function updateRecentActivity(mangaData) {
    const recentActivities = document.getElementById('recentActivities');
    if (!recentActivities) return;
    recentActivities.innerHTML = '';

    const sortedManga = [...mangaData].sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
    const recentManga = sortedManga.slice(0, 5);

    if (recentManga.length === 0) {
        recentActivities.innerHTML = '<tr><td colspan="3" class="loading">ÊöÇÊó†Ê¥ªÂä®</td></tr>';
        return;
    }

    recentManga.forEach(manga => {
        const row = document.createElement('tr');
        const uploadTime = manga.uploadTime ? new Date(manga.uploadTime).toLocaleString() : 'Êú™Áü•';
        row.innerHTML = `
        <td>‰∏ä‰º†Êº´Áîª</td>
        <td>„Ää${manga.title}„Äã</td>
        <td>${uploadTime}</td>
        `;
        recentActivities.appendChild(row);
    });
}

// ËÆæÁΩÆÊñá‰ª∂ËæìÂÖ•‰∫ã‰ª∂
function setupFileInputs() {
    const coverInput = document.getElementById('cover');
    const fileInput = document.getElementById('file');
    if (coverInput) {
        coverInput.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const file = e.target.files[0];
                const fileInfo = document.getElementById('coverInfo');
                if (fileInfo) {
                    fileInfo.innerHTML = `
                    <strong>Â∑≤ÈÄâÊã©Êñá‰ª∂Ôºö</strong>${file.name}<br>
                    <strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${(file.size / 1024).toFixed(2)} KB
                    `;
                    fileInfo.style.display = 'block';
                }
                hideError('uploadError');
            }
        });
    }
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const file = e.target.files[0];
                const fileInfo = document.getElementById('fileInfo');
                if (fileInfo) {
                    fileInfo.innerHTML = `
                    <strong>Â∑≤ÈÄâÊã©Êñá‰ª∂Ôºö</strong>${file.name}<br>
                    <strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${(file.size / (1024 * 1024)).toFixed(2)} MB
                    `;
                    fileInfo.style.display = 'block';
                }
                hideError('uploadError');
            }
        });
    }
}

// ËÆæÁΩÆÊãñÊãΩ‰∏ä‰º†
function setupDragAndDrop() {
    const coverUploadArea = document.getElementById('coverUploadArea');
    const fileUploadArea = document.getElementById('fileUploadArea');

    [coverUploadArea, fileUploadArea].forEach(area => {
        if (!area) return;
        area.addEventListener('dragover', e => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        area.addEventListener('dragleave', e => {
            e.preventDefault();
            area.classList.remove('dragover');
        });
    });

    if (coverUploadArea) {
        coverUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const coverInput = document.getElementById('cover');
                if (coverInput) {
                    const dt = new DataTransfer();
                    dt.items.add(files[0]);
                    coverInput.files = dt.files;
                    coverInput.dispatchEvent(new Event('change'));
                }
            } else {
                showError('uploadError', 'ËØ∑‰∏ä‰º† JPG„ÄÅPNG„ÄÅGIF Êàñ WebP Ê†ºÂºèÁöÑÂõæÁâáÊñá‰ª∂ÔºÅ');
                showNotification('Êñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅÔºÅ', 'error');
            }
        });
    }

    if (fileUploadArea) {
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const allowed = ['.zip', '.rar', '.cbz', '.cbr'];
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (allowed.includes(ext)) {
                    const fileInput = document.getElementById('file');
                    if (fileInput) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        fileInput.files = dt.files;
                        fileInput.dispatchEvent(new Event('change'));
                    }
                } else {
                    showError('uploadError', 'ËØ∑‰∏ä‰º† CBZ„ÄÅCBR„ÄÅZIP Êàñ RAR Ê†ºÂºèÁöÑÊº´ÁîªÊñá‰ª∂ÔºÅ');
                    showNotification('Êñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅÔºÅ', 'error');
                }
            }
        });
    }
}

// ÂàáÊç¢Ê†áÁ≠æÈ°µ
function switchTab(tabId, clickedElement) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.admin-nav a').forEach(link => link.classList.remove('active'));
    const targetTab = document.getElementById(tabId);
    if (targetTab) targetTab.classList.add('active');
    if (clickedElement) clickedElement.classList.add('active');
    if (tabId === 'dashboard') loadDashboardData();
    if (tabId === 'manga') loadMangaList(currentPage, currentSearch);
    if (tabId === 'tags') loadTagNamespaces();
}

// ‰∏ä‰º†Êº´Áîª
async function uploadManga() {
    const title = document.getElementById('mangaTitle').value;
    const author = document.getElementById('mangaAuthor').value;
    const description = document.getElementById('mangaDescription').value;
    const coverFile = document.getElementById('cover').files[0];
    const mangaFile = document.getElementById('file').files[0];

    if (!title || !author) {
        showError('uploadError', 'ËØ∑Â°´ÂÜôÊº´ÁîªÂêçÁß∞Âíå‰ΩúËÄÖÔºÅ');
        showNotification('ËØ∑Â°´ÂÜôÂøÖÂ°´Â≠óÊÆµÔºÅ', 'error');
        return;
    }
    if (!mangaFile) {
        showError('uploadError', 'ËØ∑ÈÄâÊã©Êº´ÁîªÊñá‰ª∂ÔºÅ');
        showNotification('ËØ∑ÈÄâÊã©Êº´ÁîªÊñá‰ª∂ÔºÅ', 'error');
        return;
    }

    const allowedExtensions = ['.zip', '.rar', '.cbz', '.cbr'];
    const fileExtension = '.' + mangaFile.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        showError('uploadError', 'Êº´ÁîªÊñá‰ª∂Âè™ÊîØÊåÅ CBZ„ÄÅCBR„ÄÅZIP„ÄÅRAR Ê†ºÂºèÔºÅ');
        showNotification('Êº´ÁîªÊñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅÔºÅ', 'error');
        return;
    }

    if (mangaFile.size > 200 * 1024 * 1024) {
        showError('uploadError', 'Êº´ÁîªÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá 200MBÔºÅ');
        showNotification('Êº´ÁîªÊñá‰ª∂ËøáÂ§ßÔºÅ', 'error');
        return;
    }

    if (coverFile) {
        const allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedImageTypes.includes(coverFile.type)) {
            showError('uploadError', 'Â∞ÅÈù¢ÂõæÁâáÂè™ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF„ÄÅWebP Ê†ºÂºèÔºÅ');
            showNotification('Â∞ÅÈù¢ÂõæÁâáÊ†ºÂºè‰∏çÊîØÊåÅÔºÅ', 'error');
            return;
        }
        if (coverFile.size > 5 * 1024 * 1024) {
            showError('uploadError', 'Â∞ÅÈù¢ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 5MBÔºÅ');
            showNotification('Â∞ÅÈù¢ÂõæÁâáËøáÂ§ßÔºÅ', 'error');
            return;
        }
    }

    hideError('uploadError');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressBar = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    if (uploadBtn) uploadBtn.disabled = true;
    if (progressBar) progressBar.style.display = 'block';

    try {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('author', author);
        formData.append('description', description || '');
        if (coverFile) formData.append('cover', coverFile);
        formData.append('file', mangaFile);

        const response = await fetch('/api/manga', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`
            },
            body: formData
        });
        const result = await response.json();

        if (response.ok && result.success) {
            showNotification('Êº´Áîª‰∏ä‰º†ÊàêÂäüÔºÅ', 'success');

            // Â∞ÜÊ†áÁ≠æ‰∏éÊñ∞‰∏ä‰º†ÁöÑÊº´ÁîªÂÖ≥ËÅî
            if (currentSelectedTags.length > 0) {
                await assignTagsToManga(result.manga.id, currentSelectedTags);
            }

            resetForm();
            // ‰∏ä‰º†ÊàêÂäüÂêéË∑≥ËΩ¨Âà∞Á¨¨‰∏ÄÈ°µ
            currentPage = 1;
            loadMangaList(currentPage, currentSearch);
            loadDashboardData();
        } else {
            const errorMessage = result.error || '‰∏ä‰º†Â§±Ë¥•';
            showError('uploadError', '‰∏ä‰º†Â§±Ë¥•: ' + errorMessage);
            showNotification('‰∏ä‰º†Â§±Ë¥•: ' + errorMessage, 'error');
        }
    } catch (error) {
        console.error('‰∏ä‰º†Â§±Ë¥•:', error);
        showError('uploadError', '‰∏ä‰º†Â§±Ë¥•: ' + error.message);
        showNotification('‰∏ä‰º†Â§±Ë¥•: ' + error.message, 'error');
    } finally {
        if (uploadBtn) uploadBtn.disabled = false;
        if (progressBar) progressBar.style.display = 'none';
        if (progressFill) progressFill.style.width = '0%';
    }
}

// Âä†ËΩΩÊº´ÁîªÂàóË°®Ôºà‰ΩøÁî®ÂàÜÈ°µAPIÔºâ
async function loadMangaList(page = 1, search = '') {
    try {
        showLoading('mangaList');

        // ÊûÑÂª∫Êü•ËØ¢ÂèÇÊï∞
        const params = new URLSearchParams({
            page: page.toString(),
                                           pageSize: itemsPerPage.toString()
        });

        if (search) {
            params.append('search', search);
        }

        const response = await fetch(`/api/manga?${params.toString()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();

        // ÂÅáËÆæAPIËøîÂõûÊ†ºÂºè‰∏∫ { data: [], total: 100, page: 1, pageSize: 10 }
        const mangaData = result.data || [];
        totalItems = result.total || 0;
        currentPage = result.page || 1;
        totalPages = Math.ceil(totalItems / itemsPerPage);

        renderMangaTable(mangaData);
        updatePaginationControls();
        hideError('manageError');

    } catch (error) {
        console.error('Âä†ËΩΩÊº´ÁîªÂàóË°®Â§±Ë¥•:', error);
        showError('mangaList', 'Âä†ËΩΩÂ§±Ë¥•: ' + error.message);
        showNotification('Âä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
    }
}

// ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
function showLoading(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = '<tr><td colspan="7" class="loading">Âä†ËΩΩ‰∏≠...</td></tr>';
    }
}

// Ê∏≤ÊüìÊº´ÁîªË°®Ê†º
function renderMangaTable(mangaList) {
    const el = document.getElementById('mangaList');
    if (!el) return;

    if (mangaList.length === 0) {
        el.innerHTML = '<tr><td colspan="7" class="loading">ÊöÇÊó†Êº´ÁîªÊï∞ÊçÆ</td></tr>';
        return;
    }

    el.innerHTML = '';
    mangaList.forEach(manga => {
        const row = document.createElement('tr');

        const uploadTime = manga.uploadTime ? new Date(manga.uploadTime).toLocaleDateString() : 'Êú™Áü•';
        const fileSize = manga.fileSize ? formatFileSize(manga.fileSize) : 'Êú™Áü•';
        const tagsHtml = manga.tags ? manga.tags.map(tag =>
        `<span class="manga-tag" data-tag-id="${tag.id}">${tag.name}</span>`
        ).join(' ') : '';

        row.innerHTML = `
        <td>
        <img src="/api/manga/${manga.id}/cover"
        width="50" height="70"
        style="object-fit: cover; border-radius: 4px;"
        onerror="this.src='https://placehold.co/50x70/eee/999?text=Â∞ÅÈù¢'">
        </td>
        <td>
        <div style="font-weight: bold; margin-bottom: 4px;">${manga.title}</div>
        <div style="font-size: 12px; color: #666;">${manga.description || 'ÊöÇÊó†ÊèèËø∞'}</div>
        </td>
        <td>${manga.author}</td>
        <td>${uploadTime}</td>
        <td>${fileSize}</td>
        <td><div class="manga-tags">${tagsHtml}</div></td>
        <td>
        <div class="admin-action-buttons">
        <button class="btn btn-info" data-manga-id="${manga.id}">ÁºñËæë</button>
        <button class="btn btn-warning" data-manga-id="${manga.id}" data-manga-title="${manga.title}">Á´†ËäÇ</button>
        <button class="btn btn-danger" data-manga-id="${manga.id}">Âà†Èô§</button>
        </div>
        </td>
        `;
        el.appendChild(row);
    });
}

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = parseInt(bytes);
    let unitIndex = 0;

    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }

    return `${size.toFixed(1)} ${units[unitIndex]}`;
}

// ËΩ¨‰πâÂºïÂè∑ÔºàÁî®‰∫éJavaScriptÂ≠óÁ¨¶‰∏≤Ôºâ
function escapeQuote(str) {
    return str.replace(/'/g, "\\'");
}

// ÂàÜÈ°µÊéßÂà∂ÂáΩÊï∞
function goToPage(page) {
    page = Math.max(1, Math.min(page, totalPages));
    currentPage = page;
    loadMangaList(currentPage, currentSearch);
}

function previousPage() {
    goToPage(currentPage - 1);
}

function nextPage() {
    goToPage(currentPage + 1);
}

function changePageSize(size) {
    itemsPerPage = size;
    currentPage = 1;
    loadMangaList(currentPage, currentSearch);
}

function updatePaginationControls() {
    // Êõ¥Êñ∞È°µÁ†ÅËæìÂÖ•Ê°Ü
    const pageInput = document.getElementById('currentPageInput');
    if (pageInput) {
        pageInput.value = currentPage;
        pageInput.max = totalPages;
    }

    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const firstBtn = document.getElementById('firstPage');
    const lastBtn = document.getElementById('lastPage');

    if (prevBtn) prevBtn.disabled = currentPage <= 1;
    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    if (firstBtn) firstBtn.disabled = currentPage <= 1;
    if (lastBtn) lastBtn.disabled = currentPage >= totalPages;

    // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, totalItems);
    const infoEl = document.getElementById('paginationInfo');
    if (infoEl) {
        infoEl.textContent = `ÊòæÁ§∫ ${startItem}-${endItem} Êù°ÔºåÂÖ± ${totalItems} Êù°`;
        if (currentSearch) {
            infoEl.textContent += ` (ÊêúÁ¥¢: "${currentSearch}")`;
        }
    }
}

// ÊêúÁ¥¢ÂäüËÉΩ
function searchManga() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    currentSearch = searchTerm;
    currentPage = 1;
    loadMangaList(currentPage, currentSearch);
}

function resetSearch() {
    document.getElementById('searchInput').value = '';
    currentSearch = '';
    currentPage = 1;
    loadMangaList(currentPage, '');
}

async function deleteManga(mangaId) {
    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êº´ÁîªÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) return;

    try {
        const response = await fetch(`/api/manga/${mangaId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`
            }
        });

        const result = await response.json();
        if (response.ok && result.success) {
            showNotification('Êº´ÁîªÂà†Èô§ÊàêÂäüÔºÅ', 'success');
            // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÈ°µÊï∞ÊçÆ
            loadMangaList(currentPage, currentSearch);
            loadDashboardData();
        } else {
            const errorMessage = result.error || 'Âà†Èô§Â§±Ë¥•';
            showError('manageError', 'Âà†Èô§Â§±Ë¥•: ' + errorMessage);
            showNotification('Âà†Èô§Â§±Ë¥•: ' + errorMessage, 'error');
        }
    } catch (error) {
        console.error('Âà†Èô§Â§±Ë¥•:', error);
        showError('manageError', 'Âà†Èô§Â§±Ë¥•: ' + error.message);
        showNotification('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
    }
}

function openChapterModal(mangaId, mangaTitle) {
    currentMangaId = mangaId;
    document.getElementById('mangaTitle').textContent = mangaTitle;
    document.getElementById('chapterModal').style.display = 'block';
    loadChapters(mangaId);
}

function closeChapterModal() {
    document.getElementById('chapterModal').style.display = 'none';
    document.getElementById('chapterTitle').value = '';
    document.getElementById('chapterNumber').value = '';
    document.getElementById('chapterFile').value = '';
}

function loadChapters(mangaId) {
    fetch(`/api/manga/${mangaId}/chapters`)
    .then(response => response.json())
    .then(chapters => {
        const container = document.getElementById('chapterList');
        container.innerHTML = '';
        if (chapters.length === 0) {
            container.innerHTML = '<p>ÊöÇÊó†Á´†ËäÇ</p>';
            return;
        }

        // ÊåâÁ´†ËäÇÁºñÂè∑ÊéíÂ∫è
        const sortedChapters = chapters.sort((a, b) => a.number - b.number);

        sortedChapters.forEach(chapter => {
            const item = document.createElement('div');
            item.className = 'chapter-item';
            item.innerHTML = `
            <div class="chapter-info">
            <strong>${chapter.title}</strong> (Á¨¨${chapter.number}Á´†)
            <br><small>${new Date(chapter.uploadTime).toLocaleDateString()}</small>
            </div>
            <div class="chapter-actions">
            <button class="btn btn-warning" onclick="openEditChapterModal('${chapter.id}', '${chapter.title}', ${chapter.number})">ÁºñËæë</button>
            <button class="btn btn-danger" onclick="deleteChapter('${chapter.id}')">Âà†Èô§</button>
            </div>
            `;
            container.appendChild(item);
        });
    })
    .catch(error => {
        console.error('Âä†ËΩΩÁ´†ËäÇÂ§±Ë¥•:', error);
        showNotification('Âä†ËΩΩÁ´†ËäÇÂ§±Ë¥•', 'error');
    });
}

function addChapter() {
    const title = document.getElementById('chapterTitle').value;
    const number = document.getElementById('chapterNumber').value;
    const file = document.getElementById('chapterFile').files[0];
    if (!title || !number || !file) {
        showNotification('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ', 'error');
        return;
    }
    const formData = new FormData();
    formData.append('title', title);
    formData.append('number', number);
    formData.append('chapterFile', file);
    fetch(`/api/manga/${currentMangaId}/chapters`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${adminState.sessionId}`
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Á´†ËäÇÊ∑ªÂä†ÊàêÂäü', 'success');
            document.getElementById('chapterTitle').value = '';
            document.getElementById('chapterNumber').value = '';
            document.getElementById('chapterFile').value = '';
            loadChapters(currentMangaId);
            loadMangaList(currentPage, currentSearch);
            loadDashboardData();
        } else {
            showNotification(data.error || 'Ê∑ªÂä†Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Ê∑ªÂä†Á´†ËäÇÂ§±Ë¥•:', error);
        showNotification('Ê∑ªÂä†Á´†ËäÇÂ§±Ë¥•: ' + error.message, 'error');
    });
}

function openEditChapterModal(chapterId, title, number) {
    document.getElementById('editChapterId').value = chapterId;
    document.getElementById('editChapterTitle').value = title;
    document.getElementById('editChapterNumber').value = number;
    document.getElementById('editChapterModal').style.display = 'block';
}

function closeEditChapterModal() {
    document.getElementById('editChapterModal').style.display = 'none';
}

function updateChapter() {
    const chapterId = document.getElementById('editChapterId').value;
    const title = document.getElementById('editChapterTitle').value;
    const number = document.getElementById('editChapterNumber').value;
    if (!title || !number) {
        showNotification('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ', 'error');
        return;
    }
    fetch(`/api/manga/${currentMangaId}/chapters/${chapterId}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${adminState.sessionId}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ title, number })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Á´†ËäÇÊõ¥Êñ∞ÊàêÂäü', 'success');
            closeEditChapterModal();
            loadChapters(currentMangaId);
            loadMangaList(currentPage, currentSearch);
            loadDashboardData();
        } else {
            showNotification(data.error || 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Êõ¥Êñ∞Á´†ËäÇÂ§±Ë¥•:', error);
        showNotification('Êõ¥Êñ∞Á´†ËäÇÂ§±Ë¥•: ' + error.message, 'error');
    });
}

function deleteChapter(chapterId) {
    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á´†ËäÇÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) return;
    fetch(`/api/manga/${currentMangaId}/chapters/${chapterId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${adminState.sessionId}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Á´†ËäÇÂà†Èô§ÊàêÂäü', 'success');
            loadChapters(currentMangaId);
            loadMangaList(currentPage, currentSearch);
            loadDashboardData();
        } else {
            showNotification(data.error || 'Âà†Èô§Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Âà†Èô§Á´†ËäÇÂ§±Ë¥•:', error);
        showNotification('Âà†Èô§Á´†ËäÇÂ§±Ë¥•: ' + error.message, 'error');
    });
}

function resetForm() {
    const form = document.getElementById('uploadForm');
    if (form) form.reset();
    ['coverInfo', 'fileInfo'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = 'none';
            el.innerHTML = '';
        }
    });
    hideError('uploadError');
    ['coverUploadArea', 'fileUploadArea'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('dragover');
    });
        // ÈáçÁΩÆÊ†áÁ≠æÈÄâÊã©
        currentSelectedTags = [];
        const selectedTagsContainer = document.getElementById('selectedTags');
        if (selectedTagsContainer) selectedTagsContainer.innerHTML = '';
        loadAllTags(); // ÈáçÊñ∞Âä†ËΩΩÊ†áÁ≠æÈÄâÊã©Âô®
}

async function logout() {
    if (!confirm('Á°ÆÂÆöË¶ÅÁôªÂá∫ÂêóÔºü')) return;
    try {
        const response = await fetch('/api/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`
            }
        });
        const result = await response.json();
        if (response.ok && result.success) {
            localStorage.removeItem('admin_session_id');
            window.location.href = '/login.html';
        } else {
            showNotification('ÁôªÂá∫Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    } catch (error) {
        console.error('ÁôªÂá∫Â§±Ë¥•:', error);
        showNotification('ÁôªÂá∫Â§±Ë¥•: ' + error.message, 'error');
    }
}

async function openEditMangaModal(mangaId) {
    try {
        const response = await fetch(`/api/manga/${mangaId}`);
        const manga = await response.json();
        if (!response.ok) throw new Error(manga.error || 'Ëé∑ÂèñÊº´Áîª‰ø°ÊÅØÂ§±Ë¥•');
        document.getElementById('editMangaId').value = manga.id;
        document.getElementById('editMangaTitle').value = manga.title;
        document.getElementById('editMangaAuthor').value = manga.author;
        document.getElementById('editMangaDescription').value = manga.description || '';
        document.getElementById('editMangaCover').value = '';

        // Â°´ÂÖÖÁºñËæëÊº´ÁîªÊó∂ÁöÑÊ†áÁ≠æ
        const editTagContainer = document.getElementById('editMangaTags');
        if (editTagContainer) {
            editTagContainer.innerHTML = '';
            if (manga.tags && manga.tags.length > 0) {
                manga.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'manga-tag';
                    tagElement.innerHTML = `${tag.name} <span class="remove-tag" onclick="removeTagFromManga('${manga.id}', ${tag.id})">√ó</span>`;
                    tagElement.setAttribute('data-tag-id', tag.id);
                    editTagContainer.appendChild(tagElement);
                });
            }
        }

        document.getElementById('editMangaModal').style.display = 'block';
        loadAllTags(); // Âä†ËΩΩÊâÄÊúâÊ†áÁ≠æ‰ª•‰æõÈÄâÊã©
    } catch (error) {
        console.error('ÊâìÂºÄÁºñËæëÊ®°ÊÄÅÊ°ÜÂ§±Ë¥•:', error);
        showNotification('Âä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
    }
}

function closeEditMangaModal() {
    document.getElementById('editMangaModal').style.display = 'none';
}

async function updateManga() {
    const mangaId = document.getElementById('editMangaId').value;
    const title = document.getElementById('editMangaTitle').value;
    const author = document.getElementById('editMangaAuthor').value;
    const description = document.getElementById('editMangaDescription').value;
    const coverFile = document.getElementById('editMangaCover').files[0];

    if (!title || !author) {
        showNotification('ËØ∑Â°´ÂÜôÊº´ÁîªÂêçÁß∞Âíå‰ΩúËÄÖÔºÅ', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('title', title);
    formData.append('author', author);
    formData.append('description', description);
    if (coverFile) formData.append('cover', coverFile);

    try {
        const response = await fetch(`/api/manga/${mangaId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`
            },
            body: formData
        });
        const result = await response.json();
        if (response.ok && result.success) {
            showNotification('Êº´Áîª‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
            closeEditMangaModal();
            loadMangaList(currentPage, currentSearch);
            loadDashboardData();
        } else {
            showNotification('Êõ¥Êñ∞Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    } catch (error) {
        console.error('Êõ¥Êñ∞Êº´ÁîªÂ§±Ë¥•:', error);
        showNotification('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
    }
}

// ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
window.onclick = function(event) {
    const modals = ['chapterModal', 'editChapterModal', 'editMangaModal', 'namespaceModal'];
    modals.forEach(id => {
        const modal = document.getElementById(id);
        if (event.target === modal) {
            if (id === 'chapterModal') closeChapterModal();
            else if (id === 'editChapterModal') closeEditChapterModal();
            else if (id === 'editMangaModal') closeEditMangaModal();
            else if (id === 'namespaceModal') closeNamespaceModal();
        }
    });
};

// Ê†áÁ≠æÁ≥ªÁªüÂäüËÉΩ
async function loadTagNamespaces() {
    try {
        const response = await fetch('/api/tag/namespaces');
        if (!response.ok) throw new Error('Âä†ËΩΩÊ†áÁ≠æÂàÜÁ±ªÂ§±Ë¥•');
        const namespaces = await response.json();
        adminState.namespaces = namespaces;

        const namespaceSelect = document.getElementById('namespaceSelect');
        if (namespaceSelect) {
            namespaceSelect.innerHTML = '<option value="">ÈÄâÊã©ÂàÜÁ±ª...</option>';
            namespaces.forEach(ns => {
                const option = document.createElement('option');
                option.value = ns.id;
                option.textContent = ns.display_name;
                namespaceSelect.appendChild(option);
            });
        }

        const tagSelect = document.getElementById('tagSelect');
        if (tagSelect) {
            tagSelect.innerHTML = '<option value="">ÈÄâÊã©Ê†áÁ≠æ...</option>';
            namespaces.forEach(ns => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = ns.display_name;
                tagSelect.appendChild(optgroup);
            });
        }

        const editTagSelect = document.getElementById('editTagSelect');
        if (editTagSelect) {
            editTagSelect.innerHTML = '<option value="">ÈÄâÊã©Ê†áÁ≠æ...</option>';
            namespaces.forEach(ns => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = ns.display_name;
                editTagSelect.appendChild(optgroup);
            });
        }

        loadAllTags();
    } catch (error) {
        console.error('Âä†ËΩΩÊ†áÁ≠æÂàÜÁ±ªÂ§±Ë¥•:', error);
        showNotification('Âä†ËΩΩÊ†áÁ≠æÂàÜÁ±ªÂ§±Ë¥•: ' + error.message, 'error');
    }
}

async function loadAllTags() {
    try {
        const response = await fetch('/api/tags');
        if (!response.ok) throw new Error('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•');
        const tags = await response.json();
        adminState.tags = tags;

        const tagSelect = document.getElementById('tagSelect');
        if (tagSelect) {
            // Ê∏ÖÁ©∫Áé∞ÊúâÁöÑÈÄâÈ°πÁªÑ
            Array.from(tagSelect.children).forEach(child => {
                if (child.tagName === 'OPTGROUP') {
                    child.innerHTML = '';
                }
            });

            tags.forEach(tag => {
                const namespaceOptgroup = Array.from(tagSelect.children).find(optgroup =>
                optgroup.tagName === 'OPTGROUP' &&
                optgroup.label === adminState.namespaces.find(ns => ns.id === tag.namespace_id)?.display_name
                );

                if (namespaceOptgroup) {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name;
                    namespaceOptgroup.appendChild(option);
                }
            });
        }

        const editTagSelect = document.getElementById('editTagSelect');
        if (editTagSelect) {
            // Ê∏ÖÁ©∫Áé∞ÊúâÁöÑÈÄâÈ°πÁªÑ
            Array.from(editTagSelect.children).forEach(child => {
                if (child.tagName === 'OPTGROUP') {
                    child.innerHTML = '';
                }
            });

            tags.forEach(tag => {
                const namespaceOptgroup = Array.from(editTagSelect.children).find(optgroup =>
                optgroup.tagName === 'OPTGROUP' &&
                optgroup.label === adminState.namespaces.find(ns => ns.id === tag.namespace_id)?.display_name
                );

                if (namespaceOptgroup) {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name;
                    namespaceOptgroup.appendChild(option);
                }
            });
        }
    } catch (error) {
        console.error('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•:', error);
        showNotification('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•: ' + error.message, 'error');
    }
}

async function loadTags() {
    const namespaceId = document.getElementById('namespaceSelect').value;
    try {
        let url = '/api/tags';
        if (namespaceId) {
            const namespace = adminState.namespaces.find(ns => ns.id === parseInt(namespaceId));
            if (namespace) {
                url += `?namespace=${namespace.name}`;
            }
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•');
        const tags = await response.json();

        const container = document.getElementById('tagList');
        if (!container) return;
        container.innerHTML = '';

        if (tags.length === 0) {
            container.innerHTML = '<p>ÊöÇÊó†Ê†áÁ≠æ</p>';
            return;
        }

        tags.forEach(tag => {
            const item = document.createElement('div');
            item.className = 'tag-item';
            const namespace = adminState.namespaces.find(ns => ns.id === tag.namespace_id);
            item.innerHTML = `
            <div class="tag-info">
            <strong>${tag.name}</strong>
            <small>(${namespace?.display_name || 'Êú™ÂàÜÁ±ª'})</small>
            <br><small>${tag.description || 'Êó†ÊèèËø∞'}</small>
            </div>
            <div class="tag-actions">
            <button class="btn btn-danger" onclick="deleteTag(${tag.id})">Âà†Èô§</button>
            </div>
            `;
            container.appendChild(item);
        });
    } catch (error) {
        console.error('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•:', error);
        showNotification('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•: ' + error.message, 'error');
    }
}

async function createTag() {
    const namespaceId = document.getElementById('namespaceSelect').value;
    const name = document.getElementById('tagName').value;
    const slug = document.getElementById('tagSlug').value;
    const description = document.getElementById('tagDescription').value;

    if (!namespaceId || !name || !slug) {
        showNotification('ËØ∑Â°´ÂÜôÂøÖÂ°´Â≠óÊÆµÔºÅ', 'error');
        return;
    }

    try {
        const response = await fetch('/api/tags', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ namespace_id: parseInt(namespaceId), name, slug, description })
        });

        const result = await response.json();
        if (response.ok && result.success) {
            showNotification('Ê†áÁ≠æÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
            document.getElementById('tagName').value = '';
            document.getElementById('tagSlug').value = '';
            document.getElementById('tagDescription').value = '';
            loadTags(); // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂàÜÁ±ªÁöÑÊ†áÁ≠æ
            loadAllTags(); // Êõ¥Êñ∞ÊâÄÊúâÊ†áÁ≠æ
        } else {
            showNotification('ÂàõÂª∫Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    } catch (error) {
        console.error('ÂàõÂª∫Ê†áÁ≠æÂ§±Ë¥•:', error);
        showNotification('ÂàõÂª∫Ê†áÁ≠æÂ§±Ë¥•: ' + error.message, 'error');
    }
}

async function createNamespace() {
    document.getElementById('namespaceModal').style.display = 'block';
}

function closeNamespaceModal() {
    document.getElementById('namespaceModal').style.display = 'none';
    document.getElementById('namespaceName').value = '';
    document.getElementById('namespaceDisplayName').value = '';
    document.getElementById('namespaceDescription').value = '';
}

async function createNamespaceFromModal() {
    const name = document.getElementById('namespaceName').value;
    const displayName = document.getElementById('namespaceDisplayName').value;
    const description = document.getElementById('namespaceDescription').value;

    if (!name || !displayName) {
        showNotification('ËØ∑Â°´ÂÜôÂàÜÁ±ªÂêçÁß∞ÂíåÊòæÁ§∫ÂêçÁß∞ÔºÅ', 'error');
        return;
    }

    try {
        const response = await fetch('/api/tag/namespaces', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, display_name: displayName, description })
        });

        const result = await response.json();
        if (response.ok && result.success) {
            showNotification('Ê†áÁ≠æÂàÜÁ±ªÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
            closeNamespaceModal();
            loadTagNamespaces(); // ÈáçÊñ∞Âä†ËΩΩÂàÜÁ±ª
        } else {
            showNotification('ÂàõÂª∫Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    } catch (error) {
        console.error('ÂàõÂª∫Ê†áÁ≠æÂàÜÁ±ªÂ§±Ë¥•:', error);
        showNotification('ÂàõÂª∫Ê†áÁ≠æÂàÜÁ±ªÂ§±Ë¥•: ' + error.message, 'error');
    }
}

async function deleteTag(tagId) {
    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê†áÁ≠æÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) return;
    try {
        const response = await fetch(`/api/tags/${tagId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`
            }
        });

        const result = await response.json();
        if (response.ok && result.success) {
            showNotification('Ê†áÁ≠æÂà†Èô§ÊàêÂäüÔºÅ', 'success');
            loadTags(); // ÈáçÊñ∞Âä†ËΩΩÊ†áÁ≠æ
            loadAllTags(); // Êõ¥Êñ∞ÊâÄÊúâÊ†áÁ≠æ
            loadMangaList(currentPage, currentSearch); // Êõ¥Êñ∞Êº´ÁîªÂàóË°®
        } else {
            showNotification('Âà†Èô§Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    } catch (error) {
        console.error('Âà†Èô§Ê†áÁ≠æÂ§±Ë¥•:', error);
        showNotification('Âà†Èô§Ê†áÁ≠æÂ§±Ë¥•: ' + error.message, 'error');
    }
}

function addTagToManga() {
    const tagSelect = document.getElementById('tagSelect');
    const tagId = parseInt(tagSelect.value);
    if (!tagId) {
        showNotification('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ê†áÁ≠æÔºÅ', 'error');
        return;
    }

    const tag = adminState.tags.find(t => t.id === tagId);
    if (!tag) {
        showNotification('Ê†áÁ≠æ‰∏çÂ≠òÂú®ÔºÅ', 'error');
        return;
    }

    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ê∑ªÂä†ËØ•Ê†áÁ≠æ
    if (currentSelectedTags.includes(tagId)) {
        showNotification('ËØ•Ê†áÁ≠æÂ∑≤Ê∑ªÂä†ÔºÅ', 'error');
        return;
    }

    // Ê∑ªÂä†Âà∞ÂΩìÂâçÈÄâÊã©ÁöÑÊ†áÁ≠æÂàóË°®
    currentSelectedTags.push(tagId);

    // Âú®UI‰∏≠ÊòæÁ§∫Ê†áÁ≠æ
    const selectedTagsContainer = document.getElementById('selectedTags');
    const tagElement = document.createElement('span');
    tagElement.className = 'manga-tag';
    tagElement.innerHTML = `${tag.name} <span class="remove-tag" onclick="removeTagFromCurrentList(${tagId})">√ó</span>`;
    tagElement.setAttribute('data-tag-id', tagId);
    selectedTagsContainer.appendChild(tagElement);
}

function removeTagFromCurrentList(tagId) {
    // ‰ªéÂΩìÂâçÈÄâÊã©ÁöÑÊ†áÁ≠æÂàóË°®‰∏≠ÁßªÈô§
    currentSelectedTags = currentSelectedTags.filter(id => id !== tagId);

    // ‰ªéUI‰∏≠ÁßªÈô§Ê†áÁ≠æÂÖÉÁ¥†
    const selectedTagsContainer = document.getElementById('selectedTags');
    const tagElement = selectedTagsContainer.querySelector(`[data-tag-id="${tagId}"]`);
    if (tagElement) {
        selectedTagsContainer.removeChild(tagElement);
    }
}

async function assignTagsToManga(mangaId, tagIds) {
    try {
        const promises = tagIds.map(tagId =>
        fetch(`/api/manga/${mangaId}/tags/${tagId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        );

        const responses = await Promise.all(promises);
        const results = await Promise.all(responses.map(r => r.json()));

        const hasError = results.some(result => !result.success);
        if (hasError) {
            showNotification('ÈÉ®ÂàÜÊ†áÁ≠æÂàÜÈÖçÂ§±Ë¥•ÔºÅ', 'error');
        } else {
            showNotification('Ê†áÁ≠æÂàÜÈÖçÊàêÂäüÔºÅ', 'success');
        }
    } catch (error) {
        console.error('ÂàÜÈÖçÊ†áÁ≠æÂ§±Ë¥•:', error);
        showNotification('ÂàÜÈÖçÊ†áÁ≠æÂ§±Ë¥•: ' + error.message, 'error');
    }
}

function addTagToEditManga() {
    const tagSelect = document.getElementById('editTagSelect');
    const tagId = parseInt(tagSelect.value);
    if (!tagId) {
        showNotification('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ê†áÁ≠æÔºÅ', 'error');
        return;
    }

    const tag = adminState.tags.find(t => t.id === tagId);
    if (!tag) {
        showNotification('Ê†áÁ≠æ‰∏çÂ≠òÂú®ÔºÅ', 'error');
        return;
    }

    // Âú®UI‰∏≠ÊòæÁ§∫Ê†áÁ≠æ
    const editTagContainer = document.getElementById('editMangaTags');
    const existingTag = editTagContainer.querySelector(`[data-tag-id="${tagId}"]`);
    if (existingTag) {
        showNotification('ËØ•Ê†áÁ≠æÂ∑≤Â≠òÂú®ÔºÅ', 'error');
        return;
    }

    const tagElement = document.createElement('span');
    tagElement.className = 'manga-tag';
    tagElement.innerHTML = `${tag.name} <span class="remove-tag" onclick="removeTagFromManga('${document.getElementById('editMangaId').value}', ${tagId})">√ó</span>`;
    tagElement.setAttribute('data-tag-id', tagId);
    editTagContainer.appendChild(tagElement);

    // Ê∑ªÂä†Ê†áÁ≠æÂà∞Êº´Áîª
    assignTagToManga(document.getElementById('editMangaId').value, tagId);
}

async function removeTagFromManga(mangaId, tagId) {
    try {
        const response = await fetch(`/api/manga/${mangaId}/tags/${tagId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`
            }
        });

        const result = await response.json();
        if (response.ok && result.success) {
            showNotification('Ê†áÁ≠æÁßªÈô§ÊàêÂäüÔºÅ', 'success');
            // ‰ªéUI‰∏≠ÁßªÈô§Ê†áÁ≠æ
            const editTagContainer = document.getElementById('editMangaTags');
            const tagElement = editTagContainer.querySelector(`[data-tag-id="${tagId}"]`);
            if (tagElement) {
                editTagContainer.removeChild(tagElement);
            }
            loadMangaList(currentPage, currentSearch); // Êõ¥Êñ∞Êº´ÁîªÂàóË°®
        } else {
            showNotification('ÁßªÈô§Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    } catch (error) {
        console.error('ÁßªÈô§Ê†áÁ≠æÂ§±Ë¥•:', error);
        showNotification('ÁßªÈô§Ê†áÁ≠æÂ§±Ë¥•: ' + error.message, 'error');
    }
}

async function assignTagToManga(mangaId, tagId) {
    try {
        const response = await fetch(`/api/manga/${mangaId}/tags/${tagId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${adminState.sessionId}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });

        const result = await response.json();
        if (!response.ok || !result.success) {
            showNotification('Ê∑ªÂä†Ê†áÁ≠æÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    } catch (error) {
        console.error('Ê∑ªÂä†Ê†áÁ≠æÂ§±Ë¥•:', error);
        showNotification('Ê∑ªÂä†Ê†áÁ≠æÂ§±Ë¥•: ' + error.message, 'error');
    }
}
