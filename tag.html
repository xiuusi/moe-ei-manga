<!-- tag.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标题</title>
    <!-- 引入外部样式表 -->
    <link rel="stylesheet" href="/style.css">
    <style>
        /* 标签选中状态增强 */
        .tag-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tag-item.active .tag-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* 修复动画相关样式 */
        .manga-grid {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .manga-grid.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        .manga-card {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }

        .no-manga {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">hei——！man</div>
                <ul class="nav-menu">
                    <li><a href="/">首页</a></li>
                    <li><a href="/search.html">搜索</a></li>
                    <!-- 当前页面链接已有 active 类 -->
                    <li><a href="/tag.html" class="active">标签</a></li>
                </ul>
            </div>
        </div>
    </header>

    <main class="content-section" id="resultsSection">
        <div class="container">
            <h2 class="section-title">标签分类</h2>
            <!-- 命名空间标签 -->
            <div class="namespace-tabs" id="namespaceTabs"></div>
            <!-- 标签列表 -->
            <div class="tags-container" id="tagsContainer"></div>
            <!-- 漫画列表 -->
            <div class="manga-grid" id="mangaGrid"></div>
            <div id="pagination" class="pagination"></div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 使用各种ai杂交制作的漫画网站，仅供于学习交流</p>
            <p>联系邮箱：</p>
            <!-- 统一页脚结构 -->
            <p><a href="/login.html" class="admin-link">管理后台</a></p>
        </div>
    </footer>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script>
        let allNamespaces = [];
        let allTags = {};
        let selectedNamespace = '';
        let currentTagId = null;
        let currentPage = 1;
        let totalPages = 1;
        const MANGA_PER_PAGE = window.innerWidth < 768 ? 12 : 14;

        // 渲染命名空间
        function renderNamespaceTabs(namespaces) {
            const container = document.getElementById('namespaceTabs');
            container.innerHTML = '';

            // 默认选择第一个命名空间
            if (namespaces.length > 0) {
                selectedNamespace = namespaces[0].name;
            }

            namespaces.forEach(ns => {
                const tab = document.createElement('div');
                tab.className = `namespace-tab ${selectedNamespace === ns.name ? 'active' : ''}`;
                tab.textContent = ns.display_name;
                tab.onclick = (e) => selectNamespace(ns.name, e);
                container.appendChild(tab);
            });
        }

        // 渲染标签
        function renderTags(tags) {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';
            tags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = `tag-item ${tag.namespace_name}`;
                tagEl.setAttribute('data-tag-id', tag.id);
                tagEl.innerHTML = `<span>${tag.name}</span><span class="tag-count">${tag.count}</span>`;
                tagEl.onclick = () => selectTag(tag);
                container.appendChild(tagEl);
            });
        }

        // 渲染单个漫画卡片
        function renderMangaCard(manga, index) {
            const card = document.createElement('div');
            card.className = 'manga-card';
            card.style.animationDelay = `${index * 0.1}s`; // 为每个卡片设置延迟动画
            card.onclick = () => {
                window.location.href = `/manga-detail.html?id=${manga.id}`;
            };
            card.innerHTML = `
                <img src="/api/manga/${manga.id}/cover" alt="${manga.title}" class="manga-cover"
                     onerror="this.src='https://placehold.co/200x300/eee/999?text=封面'">
                <div class="manga-info">
                    <div class="manga-title">${manga.title}</div>
                    <div class="manga-author">${manga.author}</div>
                </div>
            `;
            return card;
        }

        // 显示指定页漫画
        function displayMangaPage(pageNumber, mangaData, total) {
            const grid = document.getElementById('mangaGrid');
            const section = document.getElementById('resultsSection');

            totalPages = Math.ceil(total / MANGA_PER_PAGE);
            currentPage = pageNumber;

            grid.innerHTML = '';

            if (mangaData.length === 0) {
                grid.innerHTML = '<div class="no-manga">暂无相关漫画</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // 添加漫画卡片
            mangaData.forEach((manga, index) => {
                grid.appendChild(renderMangaCard(manga, index));
            });

            // 触发网格动画
            setTimeout(() => {
                grid.classList.add('loaded');
            }, 100);

            if (!section.classList.contains('active')) {
                section.classList.add('active');
            }

            renderPagination();
        }

        // 渲染分页按钮
        function renderPagination() {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            if (totalPages <= 1) return;

            const maxVisible = window.innerWidth < 480 ? 3 : 7;
            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible - 1);
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }

            const prev = document.createElement('button');
            prev.textContent = '‹';
            prev.disabled = currentPage === 1;
            prev.onclick = () => loadMangaPage(currentTagId, currentPage - 1);
            container.appendChild(prev);

            for (let i = start; i <= end; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                if (i === currentPage) btn.classList.add('active');
                btn.onclick = () => loadMangaPage(currentTagId, i);
                container.appendChild(btn);
            }

            const next = document.createElement('button');
            next.textContent = '›';
            next.disabled = currentPage === totalPages;
            next.onclick = () => loadMangaPage(currentTagId, currentPage + 1);
            container.appendChild(next);
        }

        // 加载指定标签的指定页漫画
        async function loadMangaPage(tagId, page) {
            const grid = document.getElementById('mangaGrid');

            // 重置动画状态
            grid.classList.remove('loaded');
            grid.innerHTML = '<div class="loading">加载中...</div>';
            document.getElementById('pagination').innerHTML = '';

            try {
                const params = new URLSearchParams({
                    tag: tagId,
                    page: page,
                    limit: MANGA_PER_PAGE
                });
                const res = await fetch(`/api/manga?${params.toString()}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const { data, total } = await res.json();
                displayMangaPage(page, data, total);
            } catch (err) {
                console.error('加载漫画失败:', err);
                grid.innerHTML = '<div class="no-manga">加载失败，请稍后重试</div>';
                document.getElementById('pagination').innerHTML = '';
            }
        }

        // 切换命名空间
        function selectNamespace(namespaceName, event) {
            selectedNamespace = namespaceName;
            document.querySelectorAll('.namespace-tab').forEach(t => t.classList.remove('active'));
            if (event.target) {
                event.target.classList.add('active');
            }
            renderTags(allTags[namespaceName] || []);

            // 重置漫画显示
            const grid = document.getElementById('mangaGrid');
            grid.classList.remove('loaded');
            grid.innerHTML = '';
            document.getElementById('pagination').innerHTML = '';
            currentTagId = null;
            document.querySelectorAll('.tag-item.active').forEach(t => t.classList.remove('active'));
        }

        // 点击标签：加载第一页漫画
        function selectTag(tag) {
            currentTagId = tag.id;

            // 移除所有标签的active类
            document.querySelectorAll('.tag-item.active').forEach(t => t.classList.remove('active'));

            // 给当前选中的标签添加active类
            const selectedTagEl = document.querySelector(`.tag-item[data-tag-id="${tag.id}"]`);
            if (selectedTagEl) {
                selectedTagEl.classList.add('active');
            }

            loadMangaPage(tag.id, 1);
        }

        // 初始化数据
        async function loadData() {
            const section = document.getElementById('resultsSection');
            try {
                const [nsRes, tagsRes] = await Promise.all([
                    fetch('/api/tag/namespaces'),
                    fetch('/api/tags')
                ]);
                allNamespaces = await nsRes.json();
                const tags = await tagsRes.json();
                allTags = {};
                allNamespaces.forEach(ns => allTags[ns.name] = []);
                tags.forEach(t => {
                    if (allTags[t.namespace_name]) {
                        allTags[t.namespace_name].push(t);
                    }
                });

                renderNamespaceTabs(allNamespaces);
                if (selectedNamespace) {
                    renderTags(allTags[selectedNamespace] || []);
                }

                section.classList.add('active');
            } catch (err) {
                console.error('初始化失败:', err);
                section.classList.add('active');
            }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
