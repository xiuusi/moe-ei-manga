admin-dashboard.html
<!-- admin-dashboard å‰¯æœ¬.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼«ç”»ç®¡ç†åå° | MangaReader</title>
    <style>
        /* ç»§æ‰¿ 1.2.2 çš„æ ¸å¿ƒ UI é£æ ¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .admin-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-logo {
            font-size: 20px;
            font-weight: bold;
        }
        .admin-nav {
            display: flex;
            gap: 20px;
        }
        .admin-nav a {
            color: #ecf0f1;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .admin-nav a:hover, .admin-nav a.active {
            background-color: #34495e;
        }
        .admin-main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none; /* é»˜è®¤éšè— */
        }
        .admin-section.active {
            display: block; /* æ˜¾ç¤ºæ´»åŠ¨æ ‡ç­¾é¡µ */
        }
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background-color: #229954;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        .btn-warning:hover {
            background-color: #d68910;
        }
        .btn-info {
            background-color: #3498db;
            color: white;
        }
        .btn-info:hover {
            background-color: #2980b9;
        }
        .btn:disabled {
            background-color: #95a5a6 !important;
            cursor: not-allowed;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #fafafa;
        }
        .upload-area:hover {
            border-color: #3498db;
            background-color: #e3f2fd;
        }
        .upload-area.dragover {
            border-color: #3498db;
            background-color: #d4edda;
        }
        .upload-area i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
            display: block;
        }
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e8f4f8;
            border-radius: 4px;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #555;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-published {
            background-color: #d4edda;
            color: #155724;
        }
        .status-draft {
            background-color: #fff3cd;
            color: #856404;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #27ae60;
        }
        .notification.error {
            background-color: #e74c3c;
        }
        .notification.info {
            background-color: #3498db;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 18px;
        }
        .error-message {
            color: #e74c3c;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        /* ç»Ÿè®¡å¡ç‰‡ - ä¿ç•™ 1.2.3 çš„ç°ä»£åŒ–è®¾è®¡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
        }
        .stat-primary { border-top: 4px solid #3498db; }
        .stat-success { border-top: 4px solid #27ae60; }
        .stat-warning { border-top: 4px solid #f39c12; }
        .stat-danger { border-top: 4px solid #e74c3c; }
        /* æœ€è¿‘æ´»åŠ¨ - ç»§æ‰¿ 1.2.2 çš„è®¾è®¡ */
        .recent-activity {
            margin-top: 30px;
        }
        .activity-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-time {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .activity-content {
            color: #333;
            font-size: 14px;
        }
        /* å¯é€‰å°é¢åŒºåŸŸæ ·å¼ */
        .optional-cover {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .optional-cover label {
            font-weight: normal !important;
            color: #856404 !important;
        }
        /* æ¨¡æ€æ¡†æ ·å¼ - ä¿ç•™ 1.2.3 çš„ç°ä»£åŒ–è®¾è®¡ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close:hover {
            color: #e74c3c;
        }
        .chapter-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0;
        }
        .chapter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .chapter-item:last-child {
            border-bottom: none;
        }
        .chapter-info {
            flex: 1;
        }
        .chapter-actions {
            display: flex;
            gap: 5px;
        }
        .tag-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0;
        }
        .tag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        .tag-item:last-child {
            border-bottom: none;
        }
        .tag-info {
            flex: 1;
        }
        .tag-actions {
            display: flex;
            gap: 5px;
        }
        .manga-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .manga-tag {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }
        .manga-tag .remove-tag {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* ç®¡ç†å‘˜åˆ†é¡µæ ·å¼ */
        .admin-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .page-btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #ff6b6b;
        }

        .page-btn.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .page-btn:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .page-input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
        }

        .page-size-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .admin-action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .admin-action-buttons .btn {
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-action-buttons .btn-info {
            background: #17a2b8;
            color: white;
        }

        .admin-action-buttons .btn-warning {
            background: #ffc107;
            color: white;
        }

        .admin-action-buttons .btn-danger {
            background: #dc3545;
            color: white;
        }

        .admin-action-buttons .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
                gap: 10px;
            }
            .admin-nav {
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            .admin-pagination {
                flex-direction: column;
                gap: 10px;
            }
            .pagination-controls {
                flex-wrap: wrap;
            }
            .search-box {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ç®¡ç†åå°å¤´éƒ¨ -->
    <header class="admin-header">
        <div class="admin-container">
            <div class="admin-logo">ğŸ“š MangaReader ç®¡ç†åå°</div>
            <nav class="admin-nav">
                <a href="#dashboard" class="active" onclick="switchTab('dashboard', this)">ä»ªè¡¨æ¿</a>
                <a href="#upload" onclick="switchTab('upload', this)">ä¸Šä¼ æ¼«ç”»</a>
                <a href="#manga" onclick="switchTab('manga', this)">æ¼«ç”»ç®¡ç†</a>
                <a href="#tags" onclick="switchTab('tags', this)">æ ‡ç­¾ç®¡ç†</a>
                <a href="#" onclick="logout()">ç™»å‡º</a>
                <a href="/">è¿”å›å‰å°</a>
            </nav>
        </div>
    </header>
    <!-- é€šçŸ¥æ¶ˆæ¯ -->
    <div id="notification" class="notification"></div>
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="admin-main">
        <!-- ä»ªè¡¨æ¿ -->
        <section id="dashboard" class="admin-section tab-content active">
            <h2 class="section-title">ä»ªè¡¨æ¿</h2>
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">ğŸ“–</div>
                    <div class="stat-number" id="totalManga">0</div>
                    <div class="stat-label">æ€»æ¼«ç”»æ•°</div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-icon">ğŸ‘ï¸</div>
                    <div class="stat-number" id="totalVisitors">0</div>
                    <div class="stat-label">æ€»è®¿é—®é‡</div>
                </div>
            </div>
            <!-- æœ€è¿‘æ´»åŠ¨ -->
            <div class="recent-activity">
                <h3>æœ€è¿‘æ´»åŠ¨</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>æ“ä½œç±»å‹</th>
                                <th>æ¼«ç”»åç§°</th>
                                <th>æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivities">
                            <tr>
                                <td colspan="3" class="loading">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <!-- ä¸Šä¼ æ¼«ç”» -->
        <section id="upload" class="admin-section tab-content">
            <h2 class="section-title">ä¸Šä¼ æ¼«ç”»</h2>
            <div id="uploadError" class="error-message"></div>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="mangaTitle">æ¼«ç”»åç§° *</label>
                    <input type="text" id="mangaTitle" name="title" required placeholder="è¯·è¾“å…¥æ¼«ç”»åç§°">
                </div>
                <div class="form-group">
                    <label for="mangaAuthor">ä½œè€… *</label>
                    <input type="text" id="mangaAuthor" name="author" required placeholder="è¯·è¾“å…¥ä½œè€…å§“å">
                </div>
                <div class="form-group">
                    <label for="mangaDescription">æ¼«ç”»ç®€ä»‹</label>
                    <textarea id="mangaDescription" name="description" placeholder="è¯·è¾“å…¥æ¼«ç”»ç®€ä»‹"></textarea>
                </div>
                <!-- æ¼«ç”»æ ‡ç­¾ -->
                <div class="form-group">
                    <label for="mangaTags">æ¼«ç”»æ ‡ç­¾</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="tagSelect" style="flex: 1;">
                            <option value="">é€‰æ‹©æ ‡ç­¾...</option>
                        </select>
                        <button type="button" class="btn btn-info" onclick="addTagToManga()">æ·»åŠ æ ‡ç­¾</button>
                    </div>
                    <div id="selectedTags" class="manga-tags" style="margin-top: 10px;">
                        <!-- æ ‡ç­¾å°†åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
                <div class="optional-cover">
                    <div class="form-group">
                        <label for="cover">å°é¢å›¾ç‰‡ (å¯é€‰ - ç•™ç©ºå°†è‡ªåŠ¨ä½¿ç”¨CBZä¸­ç¬¬ä¸€å¼ å›¾ç‰‡)</label>
                        <div class="upload-area" id="coverUploadArea" onclick="document.getElementById('cover').click()">
                            <i>ğŸ“</i>
                            <p>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡ (JPG, PNG, GIF, WebP)</p>
                            <p>æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                        </div>
                        <input type="file" id="cover" name="cover" accept="image/*" style="display: none;">
                        <div id="coverInfo" class="file-info" style="display: none;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="file">æ¼«ç”»æ–‡ä»¶ (CBZ/CBR) *</label>
                    <div class="upload-area" id="fileUploadArea" onclick="document.getElementById('file').click()">
                        <i>ğŸ“š</i>
                        <p>ç‚¹å‡»ä¸Šä¼ æ¼«ç”»æ–‡ä»¶</p>
                        <p>æ”¯æŒ CBZ, CBR, ZIP, RAR æ ¼å¼</p>
                    </div>
                    <input type="file" id="file" name="file" accept=".zip,.rar,.cbz,.cbr" style="display: none;">
                    <div id="fileInfo" class="file-info" style="display: none;"></div>
                </div>
                <div class="progress-bar" id="uploadProgress">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <button type="submit" class="btn btn-success" id="uploadBtn">ä¸Šä¼ æ¼«ç”»</button>
                <button type="button" class="btn btn-warning" onclick="resetForm()">é‡ç½®</button>
            </form>
        </section>
        <!-- æ¼«ç”»ç®¡ç† -->
        <section id="manga" class="admin-section tab-content">
            <h2 class="section-title">æ¼«ç”»ç®¡ç†</h2>
            <div id="manageError" class="error-message"></div>

            <div class="search-box" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="searchInput" placeholder="æœç´¢æ¼«ç”»åç§°æˆ–ä½œè€…..."
                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px;">
                <button class="btn btn-primary" onclick="searchManga()" style="padding: 12px 20px;">æœç´¢</button>
                <button class="btn btn-warning" onclick="resetSearch()" style="padding: 12px 20px;">é‡ç½®</button>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th width="80">å°é¢</th>
                            <th>æ¼«ç”»åç§°</th>
                            <th width="120">ä½œè€…</th>
                            <th width="120">ä¸Šä¼ æ—¶é—´</th>
                            <th width="100">æ–‡ä»¶å¤§å°</th>
                            <th width="150">æ ‡ç­¾</th>
                            <th width="200">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="mangaList">
                        <tr>
                            <td colspan="7" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="admin-pagination">
                <div class="pagination-info" id="paginationInfo">
                    æ˜¾ç¤º 0-0 æ¡ï¼Œå…± 0 æ¡
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" onclick="goToPage(1)" id="firstPage" disabled>é¦–é¡µ</button>
                    <button class="page-btn" onclick="previousPage()" id="prevPage" disabled>ä¸Šä¸€é¡µ</button>

                    <span>ç¬¬</span>
                    <input type="number" class="page-input" id="currentPageInput" min="1" value="1"
                           onchange="goToPage(parseInt(this.value))">
                    <span>é¡µ</span>

                    <button class="page-btn" onclick="nextPage()" id="nextPage" disabled>ä¸‹ä¸€é¡µ</button>
                    <button class="page-btn" onclick="goToPage(totalPages)" id="lastPage" disabled>æœ«é¡µ</button>

                    <select class="page-size-select" id="pageSizeSelect" onchange="changePageSize(parseInt(this.value))">
                        <option value="10">10æ¡/é¡µ</option>
                        <option value="20">20æ¡/é¡µ</option>
                        <option value="50">50æ¡/é¡µ</option>
                        <option value="100">100æ¡/é¡µ</option>
                    </select>
                </div>
            </div>
        </section>
        <!-- æ ‡ç­¾ç®¡ç† -->
        <section id="tags" class="admin-section tab-content">
            <h2 class="section-title">æ ‡ç­¾ç®¡ç†</h2>
            <div id="tagsError" class="error-message"></div>
            <div class="form-group">
                <label for="namespaceSelect">é€‰æ‹©æ ‡ç­¾åˆ†ç±»</label>
                <select id="namespaceSelect" onchange="loadTags()">
                    <option value="">é€‰æ‹©åˆ†ç±»...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tagName">æ ‡ç­¾åç§°</label>
                <input type="text" id="tagName" placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°">
            </div>
            <div class="form-group">
                <label for="tagSlug">æ ‡ç­¾æ ‡è¯† (è‹±æ–‡ï¼Œç”¨äºURL)</label>
                <input type="text" id="tagSlug" placeholder="è¾“å…¥æ ‡ç­¾æ ‡è¯†ï¼Œå¦‚ï¼šromance">
            </div>
            <div class="form-group">
                <label for="tagDescription">æ ‡ç­¾æè¿°</label>
                <textarea id="tagDescription" placeholder="è¾“å…¥æ ‡ç­¾æè¿°ä¿¡æ¯"></textarea>
            </div>
            <button class="btn btn-success" onclick="createTag()">åˆ›å»ºæ ‡ç­¾</button>
            <button class="btn btn-warning" onclick="createNamespace()">åˆ›å»ºæ ‡ç­¾åˆ†ç±»</button>
            <h3 style="margin-top: 30px;">æ ‡ç­¾åˆ—è¡¨</h3>
            <div id="tagList" class="tag-list">
                <!-- æ ‡ç­¾åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
    </main>
    <!-- ç« èŠ‚ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="chapterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChapterModal()">&times;</span>
            <h2>ç« èŠ‚ç®¡ç† - <span id="mangaTitle"></span></h2>
            <div class="form-group">
                <label for="chapterTitle">ç« èŠ‚æ ‡é¢˜ *</label>
                <input type="text" id="chapterTitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="chapterNumber">ç« èŠ‚ç¼–å· *</label>
                <input type="number" id="chapterNumber" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="chapterFile">ç« èŠ‚æ–‡ä»¶ *</label>
                <input type="file" id="chapterFile" class="form-control" accept=".zip,.cbz" required>
            </div>
            <button class="btn btn-success" onclick="addChapter()">æ·»åŠ ç« èŠ‚</button>
            <h3 style="margin-top: 30px;">ç°æœ‰ç« èŠ‚</h3>
            <div id="chapterList" class="chapter-list">
                <!-- ç« èŠ‚åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    <!-- ç¼–è¾‘ç« èŠ‚æ¨¡æ€æ¡† -->
    <div id="editChapterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditChapterModal()">&times;</span>
            <h2>ç¼–è¾‘ç« èŠ‚</h2>
            <input type="hidden" id="editChapterId">
            <div class="form-group">
                <label for="editChapterTitle">ç« èŠ‚æ ‡é¢˜ *</label>
                <input type="text" id="editChapterTitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editChapterNumber">ç« èŠ‚ç¼–å· *</label>
                <input type="number" id="editChapterNumber" class="form-control" required>
            </div>
            <button class="btn btn-warning" onclick="updateChapter()">æ›´æ–°ç« èŠ‚</button>
        </div>
    </div>
    <!-- ç¼–è¾‘æ¼«ç”»æ¨¡æ€æ¡† -->
    <div id="editMangaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditMangaModal()">&times;</span>
            <h2>ç¼–è¾‘æ¼«ç”»</h2>
            <input type="hidden" id="editMangaId">
            <div class="form-group">
                <label for="editMangaTitle">æ¼«ç”»åç§° *</label>
                <input type="text" id="editMangaTitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editMangaAuthor">ä½œè€… *</label>
                <input type="text" id="editMangaAuthor" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editMangaDescription">æ¼«ç”»ç®€ä»‹</label>
                <textarea id="editMangaDescription" class="form-control"></textarea>
            </div>
            <!-- ç¼–è¾‘æ¼«ç”»æ ‡ç­¾ -->
            <div class="form-group">
                <label>ç¼–è¾‘æ ‡ç­¾</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="editTagSelect" style="flex: 1;">
                        <option value="">é€‰æ‹©æ ‡ç­¾...</option>
                    </select>
                    <button type="button" class="btn btn-info" onclick="addTagToEditManga()">æ·»åŠ æ ‡ç­¾</button>
                </div>
                <div id="editMangaTags" class="manga-tags" style="margin-top: 10px;">
                    <!-- æ ‡ç­¾å°†åŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            <div class="form-group">
                <label for="editMangaCover">å°é¢å›¾ç‰‡ (å¯é€‰)</label>
                <input type="file" id="editMangaCover" class="form-control" accept="image/*">
                <small>ç•™ç©ºåˆ™ä¸ä¿®æ”¹å½“å‰å°é¢</small>
            </div>
            <button class="btn btn-warning" onclick="updateManga()">æ›´æ–°æ¼«ç”»</button>
        </div>
    </div>
    <!-- æ ‡ç­¾åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="namespaceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNamespaceModal()">&times;</span>
            <h2>åˆ›å»ºæ ‡ç­¾åˆ†ç±»</h2>
            <div class="form-group">
                <label for="namespaceName">åˆ†ç±»åç§°</label>
                <input type="text" id="namespaceName" placeholder="è¾“å…¥åˆ†ç±»åç§°ï¼Œå¦‚ï¼štype">
            </div>
            <div class="form-group">
                <label for="namespaceDisplayName">æ˜¾ç¤ºåç§°</label>
                <input type="text" id="namespaceDisplayName" placeholder="è¾“å…¥æ˜¾ç¤ºåç§°ï¼Œå¦‚ï¼šåˆ›ä½œç±»å‹">
            </div>
            <div class="form-group">
                <label for="namespaceDescription">åˆ†ç±»æè¿°</label>
                <textarea id="namespaceDescription" placeholder="è¾“å…¥åˆ†ç±»æè¿°ä¿¡æ¯"></textarea>
            </div>
            <button class="btn btn-success" onclick="createNamespaceFromModal()">åˆ›å»ºåˆ†ç±»</button>
        </div>
    </div>

    <script>
        // ç®¡ç†åå°çŠ¶æ€
        const adminState = {
            sessionId: null,
            startTime: Date.now(),
            mangaData: [],
            tags: [],
            namespaces: []
        };
        let currentMangaId = null;
        let currentSelectedTags = []; // ä¸Šä¼ æ¼«ç”»æ—¶çš„æ ‡ç­¾

        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;
        let totalItems = 0;
        let currentSearch = '';

        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    uploadManga();
                });
            }
            setupFileInputs();
            setupDragAndDrop();
            loadTagNamespaces();
            loadAllTags();

            // åˆå§‹åŒ–åˆ†é¡µ
            setTimeout(() => {
                if (document.getElementById('manga').classList.contains('active')) {
                    loadMangaList(currentPage, currentSearch);
                }
            }, 100);
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const sessionId = localStorage.getItem('admin_session_id');
                if (!sessionId) {
                    window.location.href = '/login.html';
                    return false;
                }
                const response = await fetch('/api/auth/check', {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    }
                });
                const result = await response.json();
                if (response.ok && result.authenticated) {
                    adminState.sessionId = sessionId;
                    showAdminDashboard();
                    return true;
                } else {
                    localStorage.removeItem('admin_session_id');
                    window.location.href = '/login.html';
                    return false;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                showNotification('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥', 'error');
                localStorage.removeItem('admin_session_id');
                window.location.href = '/login.html';
                return false;
            }
        }

        // æ˜¾ç¤ºç®¡ç†åå°
        function showAdminDashboard() {
            loadDashboardData();
            loadMangaList(currentPage, currentSearch);
        }

// åŠ è½½ä»ªè¡¨æ¿æ•°æ®
async function loadDashboardData() {
    try {
        // è·å–æ¼«ç”»æ€»æ•°
        const mangaCountResponse = await fetch('/api/manga?page=1&pageSize=1');
        const mangaCountData = await mangaCountResponse.json();
        const totalMangaCount = mangaCountData.total || 0;

        // è·å–ä¸€äº›æ¼«ç”»æ•°æ®ç”¨äºæœ€è¿‘æ´»åŠ¨
        const mangaResponse = await fetch('/api/manga?page=1&pageSize=5');
        const mangaData = await mangaResponse.json();
        const mangaList = mangaData.data || [];

        const statsResponse = await fetch('/api/stats');
        const statsData = await statsResponse.json();

        // æ›´æ–°ç»Ÿè®¡
        updateStatistics(totalMangaCount, statsData);
        updateRecentActivity(mangaList);
    } catch (error) {
        console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
        showNotification('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥', 'error');
    }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å‡½æ•°
function updateStatistics(totalMangaCount, statsData) {
    if (!statsData || typeof statsData !== 'object') statsData = {};

    // æ›´æ–°æ¼«ç”»æ€»æ•°
    const totalManga = document.getElementById('totalManga');
    if (totalManga) totalManga.textContent = totalMangaCount;

    // æ›´æ–°è®¿é—®è€…æ•°é‡
    const totalVisitors = document.getElementById('totalVisitors');
    if (totalVisitors) {
        const visits = statsData.totalVisits || 0;
        totalVisitors.textContent = visits;
    }
}

        // æ›´æ–°æœ€è¿‘æ´»åŠ¨
        function updateRecentActivity(mangaData) {
            const recentActivities = document.getElementById('recentActivities');
            if (!recentActivities) return;
            recentActivities.innerHTML = '';

            const sortedManga = [...mangaData].sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
            const recentManga = sortedManga.slice(0, 5);

            if (recentManga.length === 0) {
                recentActivities.innerHTML = '<tr><td colspan="3" class="loading">æš‚æ— æ´»åŠ¨</td></tr>';
                return;
            }

            recentManga.forEach(manga => {
                const row = document.createElement('tr');
                const uploadTime = manga.uploadTime ? new Date(manga.uploadTime).toLocaleString() : 'æœªçŸ¥';
                row.innerHTML = `
                    <td>ä¸Šä¼ æ¼«ç”»</td>
                    <td>ã€Š${manga.title}ã€‹</td>
                    <td>${uploadTime}</td>
                `;
                recentActivities.appendChild(row);
            });
        }

        // è®¾ç½®æ–‡ä»¶è¾“å…¥äº‹ä»¶
        function setupFileInputs() {
            const coverInput = document.getElementById('cover');
            const fileInput = document.getElementById('file');
            if (coverInput) {
                coverInput.addEventListener('change', function(e) {
                    if (e.target.files[0]) {
                        const file = e.target.files[0];
                        const fileInfo = document.getElementById('coverInfo');
                        if (fileInfo) {
                            fileInfo.innerHTML = `
                                <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong>${file.name}<br>
                                <strong>æ–‡ä»¶å¤§å°ï¼š</strong>${(file.size / 1024).toFixed(2)} KB
                            `;
                            fileInfo.style.display = 'block';
                        }
                        hideError('uploadError');
                    }
                });
            }
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files[0]) {
                        const file = e.target.files[0];
                        const fileInfo = document.getElementById('fileInfo');
                        if (fileInfo) {
                            fileInfo.innerHTML = `
                                <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong>${file.name}<br>
                                <strong>æ–‡ä»¶å¤§å°ï¼š</strong>${(file.size / (1024 * 1024)).toFixed(2)} MB
                            `;
                            fileInfo.style.display = 'block';
                        }
                        hideError('uploadError');
                    }
                });
            }
        }

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const coverUploadArea = document.getElementById('coverUploadArea');
            const fileUploadArea = document.getElementById('fileUploadArea');

            [coverUploadArea, fileUploadArea].forEach(area => {
                if (!area) return;
                area.addEventListener('dragover', e => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });
                area.addEventListener('dragleave', e => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                });
            });

            if (coverUploadArea) {
                coverUploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type.startsWith('image/')) {
                        const coverInput = document.getElementById('cover');
                        if (coverInput) {
                            const dt = new DataTransfer();
                            dt.items.add(files[0]);
                            coverInput.files = dt.files;
                            coverInput.dispatchEvent(new Event('change'));
                        }
                    } else {
                        showError('uploadError', 'è¯·ä¸Šä¼  JPGã€PNGã€GIF æˆ– WebP æ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶ï¼');
                        showNotification('æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼', 'error');
                    }
                });
            }

            if (fileUploadArea) {
                fileUploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const allowed = ['.zip', '.rar', '.cbz', '.cbr'];
                        const ext = '.' + file.name.split('.').pop().toLowerCase();
                        if (allowed.includes(ext)) {
                            const fileInput = document.getElementById('file');
                            if (fileInput) {
                                const dt = new DataTransfer();
                                dt.items.add(file);
                                fileInput.files = dt.files;
                                fileInput.dispatchEvent(new Event('change'));
                            }
                        } else {
                            showError('uploadError', 'è¯·ä¸Šä¼  CBZã€CBRã€ZIP æˆ– RAR æ ¼å¼çš„æ¼«ç”»æ–‡ä»¶ï¼');
                            showNotification('æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼', 'error');
                        }
                    }
                });
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabId, clickedElement) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-nav a').forEach(link => link.classList.remove('active'));
            const targetTab = document.getElementById(tabId);
            if (targetTab) targetTab.classList.add('active');
            if (clickedElement) clickedElement.classList.add('active');
            if (tabId === 'dashboard') loadDashboardData();
            if (tabId === 'manga') loadMangaList(currentPage, currentSearch);
            if (tabId === 'tags') loadTagNamespaces();
        }

        // ä¸Šä¼ æ¼«ç”»
        async function uploadManga() {
            const title = document.getElementById('mangaTitle').value;
            const author = document.getElementById('mangaAuthor').value;
            const description = document.getElementById('mangaDescription').value;
            const coverFile = document.getElementById('cover').files[0];
            const mangaFile = document.getElementById('file').files[0];

            if (!title || !author) {
                showError('uploadError', 'è¯·å¡«å†™æ¼«ç”»åç§°å’Œä½œè€…ï¼');
                showNotification('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼', 'error');
                return;
            }
            if (!mangaFile) {
                showError('uploadError', 'è¯·é€‰æ‹©æ¼«ç”»æ–‡ä»¶ï¼');
                showNotification('è¯·é€‰æ‹©æ¼«ç”»æ–‡ä»¶ï¼', 'error');
                return;
            }

            const allowedExtensions = ['.zip', '.rar', '.cbz', '.cbr'];
            const fileExtension = '.' + mangaFile.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                showError('uploadError', 'æ¼«ç”»æ–‡ä»¶åªæ”¯æŒ CBZã€CBRã€ZIPã€RAR æ ¼å¼ï¼');
                showNotification('æ¼«ç”»æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼', 'error');
                return;
            }

            if (mangaFile.size > 200 * 1024 * 1024) {
                showError('uploadError', 'æ¼«ç”»æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 200MBï¼');
                showNotification('æ¼«ç”»æ–‡ä»¶è¿‡å¤§ï¼', 'error');
                return;
            }

            if (coverFile) {
                const allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedImageTypes.includes(coverFile.type)) {
                    showError('uploadError', 'å°é¢å›¾ç‰‡åªæ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼ï¼');
                    showNotification('å°é¢å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒï¼', 'error');
                    return;
                }
                if (coverFile.size > 5 * 1024 * 1024) {
                    showError('uploadError', 'å°é¢å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MBï¼');
                    showNotification('å°é¢å›¾ç‰‡è¿‡å¤§ï¼', 'error');
                    return;
                }
            }

            hideError('uploadError');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            if (uploadBtn) uploadBtn.disabled = true;
            if (progressBar) progressBar.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('title', title);
                formData.append('author', author);
                formData.append('description', description || '');
                if (coverFile) formData.append('cover', coverFile);
                formData.append('file', mangaFile);

                const response = await fetch('/api/manga', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`
                    },
                    body: formData
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification('æ¼«ç”»ä¸Šä¼ æˆåŠŸï¼', 'success');

                    // å°†æ ‡ç­¾ä¸æ–°ä¸Šä¼ çš„æ¼«ç”»å…³è”
                    if (currentSelectedTags.length > 0) {
                        await assignTagsToManga(result.manga.id, currentSelectedTags);
                    }

                    resetForm();
                    // ä¸Šä¼ æˆåŠŸåè·³è½¬åˆ°ç¬¬ä¸€é¡µ
                    currentPage = 1;
                    loadMangaList(currentPage, currentSearch);
                    loadDashboardData();
                } else {
                    const errorMessage = result.error || 'ä¸Šä¼ å¤±è´¥';
                    showError('uploadError', 'ä¸Šä¼ å¤±è´¥: ' + errorMessage);
                    showNotification('ä¸Šä¼ å¤±è´¥: ' + errorMessage, 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showError('uploadError', 'ä¸Šä¼ å¤±è´¥: ' + error.message);
                showNotification('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            } finally {
                if (uploadBtn) uploadBtn.disabled = false;
                if (progressBar) progressBar.style.display = 'none';
                if (progressFill) progressFill.style.width = '0%';
            }
        }

        // åŠ è½½æ¼«ç”»åˆ—è¡¨ï¼ˆä½¿ç”¨åˆ†é¡µAPIï¼‰
        async function loadMangaList(page = 1, search = '') {
            try {
                showLoading('mangaList');

                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams({
                    page: page.toString(),
                    pageSize: itemsPerPage.toString()
                });

                if (search) {
                    params.append('search', search);
                }

                const response = await fetch(`/api/manga?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();

                // å‡è®¾APIè¿”å›æ ¼å¼ä¸º { data: [], total: 100, page: 1, pageSize: 10 }
                const mangaData = result.data || [];
                totalItems = result.total || 0;
                currentPage = result.page || 1;
                totalPages = Math.ceil(totalItems / itemsPerPage);

                renderMangaTable(mangaData);
                updatePaginationControls();
                hideError('manageError');

            } catch (error) {
                console.error('åŠ è½½æ¼«ç”»åˆ—è¡¨å¤±è´¥:', error);
                showError('mangaList', 'åŠ è½½å¤±è´¥: ' + error.message);
                showNotification('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';
            }
        }

        // æ¸²æŸ“æ¼«ç”»è¡¨æ ¼
        function renderMangaTable(mangaList) {
            const el = document.getElementById('mangaList');
            if (!el) return;

            if (mangaList.length === 0) {
                el.innerHTML = '<tr><td colspan="7" class="loading">æš‚æ— æ¼«ç”»æ•°æ®</td></tr>';
                return;
            }

            el.innerHTML = mangaList.map(manga => {
                const uploadTime = manga.uploadTime ? new Date(manga.uploadTime).toLocaleDateString() : 'æœªçŸ¥';
                const fileSize = manga.fileSize ? formatFileSize(manga.fileSize) : 'æœªçŸ¥';
                const tagsHtml = manga.tags ? manga.tags.map(tag =>
                    `<span class="manga-tag" data-tag-id="${tag.id}">${tag.name}</span>`
                ).join(' ') : '';

                return `
                    <tr>
                        <td>
                            <img src="/api/manga/${manga.id}/cover"
                                 width="50" height="70"
                                 style="object-fit: cover; border-radius: 4px;"
                                 onerror="this.src='https://placehold.co/50x70/eee/999?text=å°é¢'">
                        </td>
                        <td>
                            <div style="font-weight: bold; margin-bottom: 4px;">${manga.title}</div>
                            <div style="font-size: 12px; color: #666;">${manga.description || 'æš‚æ— æè¿°'}</div>
                        </td>
                        <td>${manga.author}</td>
                        <td>${uploadTime}</td>
                        <td>${fileSize}</td>
                        <td><div class="manga-tags">${tagsHtml}</div></td>
                        <td>
                            <div class="admin-action-buttons">
                                <button class="btn btn-info" onclick="openEditMangaModal('${manga.id}')">ç¼–è¾‘</button>
                                <button class="btn btn-warning" onclick="openChapterModal('${manga.id}', '${escapeQuote(manga.title)}')">ç« èŠ‚</button>
                                <button class="btn btn-danger" onclick="deleteManga('${manga.id}')">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = parseInt(bytes);
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        // è½¬ä¹‰å¼•å·ï¼ˆç”¨äºJavaScriptå­—ç¬¦ä¸²ï¼‰
        function escapeQuote(str) {
            return str.replace(/'/g, "\\'");
        }

        // åˆ†é¡µæ§åˆ¶å‡½æ•°
        function goToPage(page) {
            page = Math.max(1, Math.min(page, totalPages));
            currentPage = page;
            loadMangaList(currentPage, currentSearch);
        }

        function previousPage() {
            goToPage(currentPage - 1);
        }

        function nextPage() {
            goToPage(currentPage + 1);
        }

        function changePageSize(size) {
            itemsPerPage = size;
            currentPage = 1;
            loadMangaList(currentPage, currentSearch);
        }

        function updatePaginationControls() {
            // æ›´æ–°é¡µç è¾“å…¥æ¡†
            const pageInput = document.getElementById('currentPageInput');
            if (pageInput) {
                pageInput.value = currentPage;
                pageInput.max = totalPages;
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const firstBtn = document.getElementById('firstPage');
            const lastBtn = document.getElementById('lastPage');

            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
            if (firstBtn) firstBtn.disabled = currentPage <= 1;
            if (lastBtn) lastBtn.disabled = currentPage >= totalPages;

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            const infoEl = document.getElementById('paginationInfo');
            if (infoEl) {
                infoEl.textContent = `æ˜¾ç¤º ${startItem}-${endItem} æ¡ï¼Œå…± ${totalItems} æ¡`;
                if (currentSearch) {
                    infoEl.textContent += ` (æœç´¢: "${currentSearch}")`;
                }
            }
        }

        // æœç´¢åŠŸèƒ½
        function searchManga() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            currentSearch = searchTerm;
            currentPage = 1;
            loadMangaList(currentPage, currentSearch);
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 1;
            loadMangaList(currentPage, '');
        }

        async function deleteManga(mangaId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¼«ç”»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const response = await fetch(`/api/manga/${mangaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`
                    }
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showNotification('æ¼«ç”»åˆ é™¤æˆåŠŸï¼', 'success');
                    // é‡æ–°åŠ è½½å½“å‰é¡µæ•°æ®
                    loadMangaList(currentPage, currentSearch);
                    loadDashboardData();
                } else {
                    const errorMessage = result.error || 'åˆ é™¤å¤±è´¥';
                    showError('manageError', 'åˆ é™¤å¤±è´¥: ' + errorMessage);
                    showNotification('åˆ é™¤å¤±è´¥: ' + errorMessage, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showError('manageError', 'åˆ é™¤å¤±è´¥: ' + error.message);
                showNotification('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        function openChapterModal(mangaId, mangaTitle) {
            currentMangaId = mangaId;
            document.getElementById('mangaTitle').textContent = mangaTitle;
            document.getElementById('chapterModal').style.display = 'block';
            loadChapters(mangaId);
        }

        function closeChapterModal() {
            document.getElementById('chapterModal').style.display = 'none';
            document.getElementById('chapterTitle').value = '';
            document.getElementById('chapterNumber').value = '';
            document.getElementById('chapterFile').value = '';
        }

        function loadChapters(mangaId) {
            fetch(`/api/manga/${mangaId}/chapters`)
                .then(response => response.json())
                .then(chapters => {
                    const container = document.getElementById('chapterList');
                    container.innerHTML = '';
                    if (chapters.length === 0) {
                        container.innerHTML = '<p>æš‚æ— ç« èŠ‚</p>';
                        return;
                    }

                    // æŒ‰ç« èŠ‚ç¼–å·æ’åº
                    const sortedChapters = chapters.sort((a, b) => a.number - b.number);

                    sortedChapters.forEach(chapter => {
                        const item = document.createElement('div');
                        item.className = 'chapter-item';
                        item.innerHTML = `
                            <div class="chapter-info">
                                <strong>${chapter.title}</strong> (ç¬¬${chapter.number}ç« )
                                <br><small>${new Date(chapter.uploadTime).toLocaleDateString()}</small>
                            </div>
                            <div class="chapter-actions">
                                <button class="btn btn-warning" onclick="openEditChapterModal('${chapter.id}', '${chapter.title}', ${chapter.number})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteChapter('${chapter.id}')">åˆ é™¤</button>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½ç« èŠ‚å¤±è´¥:', error);
                    showNotification('åŠ è½½ç« èŠ‚å¤±è´¥', 'error');
                });
        }

        function addChapter() {
            const title = document.getElementById('chapterTitle').value;
            const number = document.getElementById('chapterNumber').value;
            const file = document.getElementById('chapterFile').files[0];
            if (!title || !number || !file) {
                showNotification('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }
            const formData = new FormData();
            formData.append('title', title);
            formData.append('number', number);
            formData.append('chapterFile', file);
            fetch(`/api/manga/${currentMangaId}/chapters`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${adminState.sessionId}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('ç« èŠ‚æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('chapterTitle').value = '';
                    document.getElementById('chapterNumber').value = '';
                    document.getElementById('chapterFile').value = '';
                    loadChapters(currentMangaId);
                    loadMangaList(currentPage, currentSearch);
                    loadDashboardData();
                } else {
                    showNotification(data.error || 'æ·»åŠ å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('æ·»åŠ ç« èŠ‚å¤±è´¥:', error);
                showNotification('æ·»åŠ ç« èŠ‚å¤±è´¥: ' + error.message, 'error');
            });
        }

        function openEditChapterModal(chapterId, title, number) {
            document.getElementById('editChapterId').value = chapterId;
            document.getElementById('editChapterTitle').value = title;
            document.getElementById('editChapterNumber').value = number;
            document.getElementById('editChapterModal').style.display = 'block';
        }

        function closeEditChapterModal() {
            document.getElementById('editChapterModal').style.display = 'none';
        }

        function updateChapter() {
            const chapterId = document.getElementById('editChapterId').value;
            const title = document.getElementById('editChapterTitle').value;
            const number = document.getElementById('editChapterNumber').value;
            if (!title || !number) {
                showNotification('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }
            fetch(`/api/manga/${currentMangaId}/chapters/${chapterId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${adminState.sessionId}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title, number })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('ç« èŠ‚æ›´æ–°æˆåŠŸ', 'success');
                    closeEditChapterModal();
                    loadChapters(currentMangaId);
                    loadMangaList(currentPage, currentSearch);
                    loadDashboardData();
                } else {
                    showNotification(data.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('æ›´æ–°ç« èŠ‚å¤±è´¥:', error);
                showNotification('æ›´æ–°ç« èŠ‚å¤±è´¥: ' + error.message, 'error');
            });
        }

        function deleteChapter(chapterId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç« èŠ‚å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            fetch(`/api/manga/${currentMangaId}/chapters/${chapterId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminState.sessionId}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('ç« èŠ‚åˆ é™¤æˆåŠŸ', 'success');
                    loadChapters(currentMangaId);
                    loadMangaList(currentPage, currentSearch);
                    loadDashboardData();
                } else {
                    showNotification(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤ç« èŠ‚å¤±è´¥:', error);
                showNotification('åˆ é™¤ç« èŠ‚å¤±è´¥: ' + error.message, 'error');
            });
        }

        function resetForm() {
            const form = document.getElementById('uploadForm');
            if (form) form.reset();
            ['coverInfo', 'fileInfo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.display = 'none';
                    el.innerHTML = '';
                }
            });
            hideError('uploadError');
            ['coverUploadArea', 'fileUploadArea'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('dragover');
            });
            // é‡ç½®æ ‡ç­¾é€‰æ‹©
            currentSelectedTags = [];
            const selectedTagsContainer = document.getElementById('selectedTags');
            if (selectedTagsContainer) selectedTagsContainer.innerHTML = '';
            loadAllTags(); // é‡æ–°åŠ è½½æ ‡ç­¾é€‰æ‹©å™¨
        }

        async function logout() {
            if (!confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`
                    }
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    localStorage.removeItem('admin_session_id');
                    window.location.href = '/login.html';
                } else {
                    showNotification('ç™»å‡ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
                showNotification('ç™»å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function openEditMangaModal(mangaId) {
            try {
                const response = await fetch(`/api/manga/${mangaId}`);
                const manga = await response.json();
                if (!response.ok) throw new Error(manga.error || 'è·å–æ¼«ç”»ä¿¡æ¯å¤±è´¥');
                document.getElementById('editMangaId').value = manga.id;
                document.getElementById('editMangaTitle').value = manga.title;
                document.getElementById('editMangaAuthor').value = manga.author;
                document.getElementById('editMangaDescription').value = manga.description || '';
                document.getElementById('editMangaCover').value = '';

                // å¡«å……ç¼–è¾‘æ¼«ç”»æ—¶çš„æ ‡ç­¾
                const editTagContainer = document.getElementById('editMangaTags');
                if (editTagContainer) {
                    editTagContainer.innerHTML = '';
                    if (manga.tags && manga.tags.length > 0) {
                        manga.tags.forEach(tag => {
                            const tagElement = document.createElement('span');
                            tagElement.className = 'manga-tag';
                            tagElement.innerHTML = `${tag.name} <span class="remove-tag" onclick="removeTagFromManga('${manga.id}', ${tag.id})">Ã—</span>`;
                            tagElement.setAttribute('data-tag-id', tag.id);
                            editTagContainer.appendChild(tagElement);
                        });
                    }
                }

                document.getElementById('editMangaModal').style.display = 'block';
                loadAllTags(); // åŠ è½½æ‰€æœ‰æ ‡ç­¾ä»¥ä¾›é€‰æ‹©
            } catch (error) {
                console.error('æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†å¤±è´¥:', error);
                showNotification('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        function closeEditMangaModal() {
            document.getElementById('editMangaModal').style.display = 'none';
        }

        async function updateManga() {
            const mangaId = document.getElementById('editMangaId').value;
            const title = document.getElementById('editMangaTitle').value;
            const author = document.getElementById('editMangaAuthor').value;
            const description = document.getElementById('editMangaDescription').value;
            const coverFile = document.getElementById('editMangaCover').files[0];

            if (!title || !author) {
                showNotification('è¯·å¡«å†™æ¼«ç”»åç§°å’Œä½œè€…ï¼', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('author', author);
            formData.append('description', description);
            if (coverFile) formData.append('cover', coverFile);

            try {
                const response = await fetch(`/api/manga/${mangaId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`
                    },
                    body: formData
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showNotification('æ¼«ç”»ä¿¡æ¯æ›´æ–°æˆåŠŸï¼', 'success');
                    closeEditMangaModal();
                    loadMangaList(currentPage, currentSearch);
                    loadDashboardData();
                } else {
                    showNotification('æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°æ¼«ç”»å¤±è´¥:', error);
                showNotification('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = ['chapterModal', 'editChapterModal', 'editMangaModal', 'namespaceModal'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (event.target === modal) {
                    if (id === 'chapterModal') closeChapterModal();
                    else if (id === 'editChapterModal') closeEditChapterModal();
                    else if (id === 'editMangaModal') closeEditMangaModal();
                    else if (id === 'namespaceModal') closeNamespaceModal();
                }
            });
        };

        // æ ‡ç­¾ç³»ç»ŸåŠŸèƒ½
        async function loadTagNamespaces() {
            try {
                const response = await fetch('/api/tag/namespaces');
                if (!response.ok) throw new Error('åŠ è½½æ ‡ç­¾åˆ†ç±»å¤±è´¥');
                const namespaces = await response.json();
                adminState.namespaces = namespaces;

                const namespaceSelect = document.getElementById('namespaceSelect');
                if (namespaceSelect) {
                    namespaceSelect.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»...</option>';
                    namespaces.forEach(ns => {
                        const option = document.createElement('option');
                        option.value = ns.id;
                        option.textContent = ns.display_name;
                        namespaceSelect.appendChild(option);
                    });
                }

                const tagSelect = document.getElementById('tagSelect');
                if (tagSelect) {
                    tagSelect.innerHTML = '<option value="">é€‰æ‹©æ ‡ç­¾...</option>';
                    namespaces.forEach(ns => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = ns.display_name;
                        tagSelect.appendChild(optgroup);
                    });
                }

                const editTagSelect = document.getElementById('editTagSelect');
                if (editTagSelect) {
                    editTagSelect.innerHTML = '<option value="">é€‰æ‹©æ ‡ç­¾...</option>';
                    namespaces.forEach(ns => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = ns.display_name;
                        editTagSelect.appendChild(optgroup);
                    });
                }

                loadAllTags();
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾åˆ†ç±»å¤±è´¥:', error);
                showNotification('åŠ è½½æ ‡ç­¾åˆ†ç±»å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadAllTags() {
            try {
                const response = await fetch('/api/tags');
                if (!response.ok) throw new Error('åŠ è½½æ ‡ç­¾å¤±è´¥');
                const tags = await response.json();
                adminState.tags = tags;

                const tagSelect = document.getElementById('tagSelect');
                if (tagSelect) {
                    // æ¸…ç©ºç°æœ‰çš„é€‰é¡¹ç»„
                    Array.from(tagSelect.children).forEach(child => {
                        if (child.tagName === 'OPTGROUP') {
                            child.innerHTML = '';
                        }
                    });

                    tags.forEach(tag => {
                        const namespaceOptgroup = Array.from(tagSelect.children).find(optgroup =>
                            optgroup.tagName === 'OPTGROUP' &&
                            optgroup.label === adminState.namespaces.find(ns => ns.id === tag.namespace_id)?.display_name
                        );

                        if (namespaceOptgroup) {
                            const option = document.createElement('option');
                            option.value = tag.id;
                            option.textContent = tag.name;
                            namespaceOptgroup.appendChild(option);
                        }
                    });
                }

                const editTagSelect = document.getElementById('editTagSelect');
                if (editTagSelect) {
                    // æ¸…ç©ºç°æœ‰çš„é€‰é¡¹ç»„
                    Array.from(editTagSelect.children).forEach(child => {
                        if (child.tagName === 'OPTGROUP') {
                            child.innerHTML = '';
                        }
                    });

                    tags.forEach(tag => {
                        const namespaceOptgroup = Array.from(editTagSelect.children).find(optgroup =>
                            optgroup.tagName === 'OPTGROUP' &&
                            optgroup.label === adminState.namespaces.find(ns => ns.id === tag.namespace_id)?.display_name
                        );

                        if (namespaceOptgroup) {
                            const option = document.createElement('option');
                            option.value = tag.id;
                            option.textContent = tag.name;
                            namespaceOptgroup.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
                showNotification('åŠ è½½æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadTags() {
            const namespaceId = document.getElementById('namespaceSelect').value;
            try {
                let url = '/api/tags';
                if (namespaceId) {
                    const namespace = adminState.namespaces.find(ns => ns.id === parseInt(namespaceId));
                    if (namespace) {
                        url += `?namespace=${namespace.name}`;
                    }
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('åŠ è½½æ ‡ç­¾å¤±è´¥');
                const tags = await response.json();

                const container = document.getElementById('tagList');
                if (!container) return;
                container.innerHTML = '';

                if (tags.length === 0) {
                    container.innerHTML = '<p>æš‚æ— æ ‡ç­¾</p>';
                    return;
                }

                tags.forEach(tag => {
                    const item = document.createElement('div');
                    item.className = 'tag-item';
                    const namespace = adminState.namespaces.find(ns => ns.id === tag.namespace_id);
                    item.innerHTML = `
                        <div class="tag-info">
                            <strong>${tag.name}</strong>
                            <small>(${namespace?.display_name || 'æœªåˆ†ç±»'})</small>
                            <br><small>${tag.description || 'æ— æè¿°'}</small>
                        </div>
                        <div class="tag-actions">
                            <button class="btn btn-danger" onclick="deleteTag(${tag.id})">åˆ é™¤</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
                showNotification('åŠ è½½æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function createTag() {
            const namespaceId = document.getElementById('namespaceSelect').value;
            const name = document.getElementById('tagName').value;
            const slug = document.getElementById('tagSlug').value;
            const description = document.getElementById('tagDescription').value;

            if (!namespaceId || !name || !slug) {
                showNotification('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼', 'error');
                return;
            }

            try {
                const response = await fetch('/api/tags', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ namespace_id: parseInt(namespaceId), name, slug, description })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showNotification('æ ‡ç­¾åˆ›å»ºæˆåŠŸï¼', 'success');
                    document.getElementById('tagName').value = '';
                    document.getElementById('tagSlug').value = '';
                    document.getElementById('tagDescription').value = '';
                    loadTags(); // é‡æ–°åŠ è½½å½“å‰åˆ†ç±»çš„æ ‡ç­¾
                    loadAllTags(); // æ›´æ–°æ‰€æœ‰æ ‡ç­¾
                } else {
                    showNotification('åˆ›å»ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºæ ‡ç­¾å¤±è´¥:', error);
                showNotification('åˆ›å»ºæ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function createNamespace() {
            document.getElementById('namespaceModal').style.display = 'block';
        }

        function closeNamespaceModal() {
            document.getElementById('namespaceModal').style.display = 'none';
            document.getElementById('namespaceName').value = '';
            document.getElementById('namespaceDisplayName').value = '';
            document.getElementById('namespaceDescription').value = '';
        }

        async function createNamespaceFromModal() {
            const name = document.getElementById('namespaceName').value;
            const displayName = document.getElementById('namespaceDisplayName').value;
            const description = document.getElementById('namespaceDescription').value;

            if (!name || !displayName) {
                showNotification('è¯·å¡«å†™åˆ†ç±»åç§°å’Œæ˜¾ç¤ºåç§°ï¼', 'error');
                return;
            }

            try {
                const response = await fetch('/api/tag/namespaces', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, display_name: displayName, description })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showNotification('æ ‡ç­¾åˆ†ç±»åˆ›å»ºæˆåŠŸï¼', 'success');
                    closeNamespaceModal();
                    loadTagNamespaces(); // é‡æ–°åŠ è½½åˆ†ç±»
                } else {
                    showNotification('åˆ›å»ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºæ ‡ç­¾åˆ†ç±»å¤±è´¥:', error);
                showNotification('åˆ›å»ºæ ‡ç­¾åˆ†ç±»å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTag(tagId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡ç­¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const response = await fetch(`/api/tags/${tagId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`
                    }
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showNotification('æ ‡ç­¾åˆ é™¤æˆåŠŸï¼', 'success');
                    loadTags(); // é‡æ–°åŠ è½½æ ‡ç­¾
                    loadAllTags(); // æ›´æ–°æ‰€æœ‰æ ‡ç­¾
                    loadMangaList(currentPage, currentSearch); // æ›´æ–°æ¼«ç”»åˆ—è¡¨
                } else {
                    showNotification('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ ‡ç­¾å¤±è´¥:', error);
                showNotification('åˆ é™¤æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        function addTagToManga() {
            const tagSelect = document.getElementById('tagSelect');
            const tagId = parseInt(tagSelect.value);
            if (!tagId) {
                showNotification('è¯·é€‰æ‹©ä¸€ä¸ªæ ‡ç­¾ï¼', 'error');
                return;
            }

            const tag = adminState.tags.find(t => t.id === tagId);
            if (!tag) {
                showNotification('æ ‡ç­¾ä¸å­˜åœ¨ï¼', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ è¯¥æ ‡ç­¾
            if (currentSelectedTags.includes(tagId)) {
                showNotification('è¯¥æ ‡ç­¾å·²æ·»åŠ ï¼', 'error');
                return;
            }

            // æ·»åŠ åˆ°å½“å‰é€‰æ‹©çš„æ ‡ç­¾åˆ—è¡¨
            currentSelectedTags.push(tagId);

            // åœ¨UIä¸­æ˜¾ç¤ºæ ‡ç­¾
            const selectedTagsContainer = document.getElementById('selectedTags');
            const tagElement = document.createElement('span');
            tagElement.className = 'manga-tag';
            tagElement.innerHTML = `${tag.name} <span class="remove-tag" onclick="removeTagFromCurrentList(${tagId})">Ã—</span>`;
            tagElement.setAttribute('data-tag-id', tagId);
            selectedTagsContainer.appendChild(tagElement);
        }

        function removeTagFromCurrentList(tagId) {
            // ä»å½“å‰é€‰æ‹©çš„æ ‡ç­¾åˆ—è¡¨ä¸­ç§»é™¤
            currentSelectedTags = currentSelectedTags.filter(id => id !== tagId);

            // ä»UIä¸­ç§»é™¤æ ‡ç­¾å…ƒç´ 
            const selectedTagsContainer = document.getElementById('selectedTags');
            const tagElement = selectedTagsContainer.querySelector(`[data-tag-id="${tagId}"]`);
            if (tagElement) {
                selectedTagsContainer.removeChild(tagElement);
            }
        }

        async function assignTagsToManga(mangaId, tagIds) {
            try {
                const promises = tagIds.map(tagId =>
                    fetch(`/api/manga/${mangaId}/tags/${tagId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminState.sessionId}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    })
                );

                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));

                const hasError = results.some(result => !result.success);
                if (hasError) {
                    showNotification('éƒ¨åˆ†æ ‡ç­¾åˆ†é…å¤±è´¥ï¼', 'error');
                } else {
                    showNotification('æ ‡ç­¾åˆ†é…æˆåŠŸï¼', 'success');
                }
            } catch (error) {
                console.error('åˆ†é…æ ‡ç­¾å¤±è´¥:', error);
                showNotification('åˆ†é…æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        function addTagToEditManga() {
            const tagSelect = document.getElementById('editTagSelect');
            const tagId = parseInt(tagSelect.value);
            if (!tagId) {
                showNotification('è¯·é€‰æ‹©ä¸€ä¸ªæ ‡ç­¾ï¼', 'error');
                return;
            }

            const tag = adminState.tags.find(t => t.id === tagId);
            if (!tag) {
                showNotification('æ ‡ç­¾ä¸å­˜åœ¨ï¼', 'error');
                return;
            }

            // åœ¨UIä¸­æ˜¾ç¤ºæ ‡ç­¾
            const editTagContainer = document.getElementById('editMangaTags');
            const existingTag = editTagContainer.querySelector(`[data-tag-id="${tagId}"]`);
            if (existingTag) {
                showNotification('è¯¥æ ‡ç­¾å·²å­˜åœ¨ï¼', 'error');
                return;
            }

            const tagElement = document.createElement('span');
            tagElement.className = 'manga-tag';
            tagElement.innerHTML = `${tag.name} <span class="remove-tag" onclick="removeTagFromManga('${document.getElementById('editMangaId').value}', ${tagId})">Ã—</span>`;
            tagElement.setAttribute('data-tag-id', tagId);
            editTagContainer.appendChild(tagElement);

            // æ·»åŠ æ ‡ç­¾åˆ°æ¼«ç”»
            assignTagToManga(document.getElementById('editMangaId').value, tagId);
        }

        async function removeTagFromManga(mangaId, tagId) {
            try {
                const response = await fetch(`/api/manga/${mangaId}/tags/${tagId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`
                    }
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showNotification('æ ‡ç­¾ç§»é™¤æˆåŠŸï¼', 'success');
                    // ä»UIä¸­ç§»é™¤æ ‡ç­¾
                    const editTagContainer = document.getElementById('editMangaTags');
                    const tagElement = editTagContainer.querySelector(`[data-tag-id="${tagId}"]`);
                    if (tagElement) {
                        editTagContainer.removeChild(tagElement);
                    }
                    loadMangaList(currentPage, currentSearch); // æ›´æ–°æ¼«ç”»åˆ—è¡¨
                } else {
                    showNotification('ç§»é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ç§»é™¤æ ‡ç­¾å¤±è´¥:', error);
                showNotification('ç§»é™¤æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function assignTagToManga(mangaId, tagId) {
            try {
                const response = await fetch(`/api/manga/${mangaId}/tags/${tagId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminState.sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    showNotification('æ·»åŠ æ ‡ç­¾å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ æ ‡ç­¾å¤±è´¥:', error);
                showNotification('æ·»åŠ æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>

</body>
</html>
