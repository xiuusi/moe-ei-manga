<!-- manga-detail.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">漫画详情 | 网站名称</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 标签样式 */
        .manga-tags {
            margin: 15px 0;
        }

        .tags-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tag-item {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            color: #666;
            transition: all 0.2s ease;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .tag-item:hover {
            background-color: #e0e0e0;
            color: #333;
            transform: translateY(-1px);
        }

        .tag-namespace {
            font-weight: 500;
            margin-right: 4px;
            color: #888;
        }

        .no-tags {
            color: #999;
            font-style: italic;
            font-size: 14px;
        }

        /* 标签分类样式 */
        .tag-namespace-type .tag-item {
            background-color: #e3f2fd;
            border-color: #90caf9;
            color: #1565c0;
        }

        .tag-namespace-artist .tag-item {
            background-color: #f3e5f5;
            border-color: #ce93d8;
            color: #7b1fa2;
        }

        .tag-namespace-character .tag-item {
            background-color: #e8f5e9;
            border-color: #a5d6a7;
            color: #2e7d32;
        }

        .tag-namespace-main .tag-item {
            background-color: #fff3e0;
            border-color: #ffcc80;
            color: #ef6c00;
        }

        .tag-namespace-sub .tag-item {
            background-color: #fafafa;
            border-color: #e0e0e0;
            color: #757575;
        }

        .tag-item {
            cursor: pointer;
        }
        
        .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 标签详情区域样式 */
        .tag-detail-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .tag-detail-header {
            margin-bottom: 15px;
        }

        .tag-detail-header h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }

        .tag-detail-header p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }

        .tag-manga-list h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        #tagMangaGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .tag-manga-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .tag-manga-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .tag-manga-cover {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .tag-manga-info {
            padding: 10px;
        }

        .tag-manga-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tag-manga-author {
            font-size: 12px;
            color: #666;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 加载状态样式 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #d32f2f;
            font-size: 16px;
        }

        .no-manga {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 16px;
        }

        /* 分页样式 */
        .pagination-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(.active) {
            background-color: #f0f0f0;
            border-color: #999;
        }

        .pagination-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        /* 新增页面过渡动画 */
        /* 主内容容器动画 */
        .manga-detail-content {
            opacity: 1; /* 默认是可见的 */
            transform: translateY(0); /* 默认位置 */
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        /* 当页面刚开始加载时，添加一个类来实现进入动画 */
        .manga-detail-content.loading {
            opacity: 0;
            transform: translateY(20px);
        }

        .manga-detail-content.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* 标签详情区域动画 */
        .tag-detail-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s ease;
            visibility: hidden;
        }

        .tag-detail-section.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        /* 标签相关漫画卡片动画 */
        .tag-manga-card {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .tag-manga-card.animate {
            opacity: 1;
            transform: translateY(0);
        }

        /* 章节卡片动画 */
        .chapter-card {
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .chapter-card.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* 渐进式动画延迟 */
        .chapter-card:nth-child(1) { transition-delay: 0.05s; }
        .chapter-card:nth-child(2) { transition-delay: 0.1s; }
        .chapter-card:nth-child(3) { transition-delay: 0.15s; }
        .chapter-card:nth-child(4) { transition-delay: 0.2s; }
        .chapter-card:nth-child(5) { transition-delay: 0.25s; }
        .chapter-card:nth-child(6) { transition-delay: 0.3s; }
        .chapter-card:nth-child(7) { transition-delay: 0.35s; }
        .chapter-card:nth-child(8) { transition-delay: 0.4s; }
        .chapter-card:nth-child(9) { transition-delay: 0.45s; }
        .chapter-card:nth-child(10) { transition-delay: 0.5s; }
        .chapter-card:nth-child(11) { transition-delay: 0.55s; }
        .chapter-card:nth-child(12) { transition-delay: 0.6s; }
        .chapter-card:nth-child(13) { transition-delay: 0.65s; }
        .chapter-card:nth-child(14) { transition-delay: 0.7s; }
        .chapter-card:nth-child(15) { transition-delay: 0.75s; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">网站Logo</div>
                <ul class="nav-menu">
                    <li><a href="/">首页</a></li>
                    <li><a href="/?page=search">搜索</a></li>
                    <li><a href="/?page=tag">标签</a></li>
                </ul>
            </div>
        </div>
    </header>
    <main class="manga-detail-container">
        <div class="manga-detail-content">
            <div id="mangaDetailContent">
                <!-- 骨架屏加载动画 -->
                <div class="loading-skeleton">
                    <div class="skeleton-header">
                        <div class="skeleton-cover"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-author"></div>
                            <div class="skeleton-description"></div>
                            <div class="skeleton-description"></div>
                            <div class="skeleton-description short"></div>
                            <div class="skeleton-button"></div>
                        </div>
                    </div>
                    <div class="skeleton-chapters">
                        <div class="skeleton-section-title"></div>
                        <div class="skeleton-chapter-grid">
                            <div class="skeleton-chapter"></div>
                            <div class="skeleton-chapter"></div>
                            <div class="skeleton-chapter"></div>
                            <div class="skeleton-chapter"></div>
                            <div class="skeleton-chapter"></div>
                            <div class="skeleton-chapter"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 网站名称 - 网站描述</p>
            <p>联系邮箱：your-email@example.com</p>
        </div>
    </footer>
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        function getMangaId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        async function loadMangaDetail() {
            const mangaId = getMangaId();
            if (!mangaId) {
                document.getElementById('mangaDetailContent').innerHTML = `
                    <div class="error-message">
                        <p>缺少漫画ID参数</p>
                        <p><a href="/">返回首页</a></p>
                    </div>
                `;
                return;
            }

            try {
                const mangaResponse = await fetch(`/api/manga/${mangaId}`);
                if (!mangaResponse.ok) throw new Error(`HTTP error! status: ${mangaResponse.status}`);

                const manga = await mangaResponse.json();

                const chaptersResponse = await fetch(`/api/manga/${mangaId}/chapters`);
                if (!chaptersResponse.ok) throw new Error(`HTTP error! status: ${chaptersResponse.status}`);

                const chapters = await chaptersResponse.json();

                document.getElementById('pageTitle').textContent = `${manga.title} | 网站名称`;

                renderMangaDetail(manga, chapters);
            } catch (error) {
                console.error('加载漫画详情失败:', error);
                document.getElementById('mangaDetailContent').innerHTML = `
                    <div class="error-message">
                        <p>加载失败: ${error.message}</p>
                        <p>请确保服务器正在运行</p>
                        <p><a href="/">返回首页</a></p>
                    </div>
                `;
            }
        }

        function getReadingProgress(mangaId) {
            const data = localStorage.getItem(`readingProgress_${mangaId}`);
            return data ? JSON.parse(data) : null;
        }

        function setReadingProgress(mangaId, chapterId, pageNum) {
            const progress = {
                chapterId: chapterId,
                pageNum: pageNum,
                timestamp: Date.now()
            };
            localStorage.setItem(`readingProgress_${mangaId}`, JSON.stringify(progress));
        }

        // 命名空间ID到名称的映射
        const namespaceIdToName = {
            1: 'type',
            2: 'artist',
            3: 'character',
            4: 'main',
            5: 'sub'
        };

        // 命名空间显示名称映射
        const namespaceDisplayMap = {
            'type': '类型',
            'artist': '作者',
            'character': '角色',
            'main': '主标签',
            'sub': '副标签'
        };

        // 按命名空间分组标签
        function groupTagsByNamespace(tags) {
            const grouped = {};

            if (!Array.isArray(tags)) {
                console.warn('标签数据不是数组:', tags);
                return grouped;
            }

            tags.forEach(tag => {
                if (!tag || typeof tag !== 'object') {
                    console.warn('无效的标签对象:', tag);
                    return;
                }

                // 使用namespace_id获取命名空间名称
                const namespaceId = tag.namespace_id;
                const namespace = namespaceIdToName[namespaceId] || 'unknown';

                if (!grouped[namespace]) {
                    grouped[namespace] = [];
                }
                grouped[namespace].push(tag);
            });
            return grouped;
        }

        // 获取命名空间的显示名称
        function getNamespaceDisplayName(namespace) {
            return namespaceDisplayMap[namespace] || namespace;
        }

        // 渲染标签
        function renderTags(tags) {
            if (!tags || !Array.isArray(tags) || tags.length === 0) {
                return '<div class="no-tags">暂无标签</div>';
            }

            const groupedTags = groupTagsByNamespace(tags);
            let html = '';

            // 按命名空间显示标签
            Object.keys(groupedTags).forEach(namespace => {
                const namespaceTags = groupedTags[namespace];
                const displayName = getNamespaceDisplayName(namespace);

                html += `
                    <div class="tags-container tag-namespace-${namespace}">
                        ${namespaceTags.map(tag => {
                            const tagDescription = tag.description || tag.name;

                            return `
                                <div class="tag-item" data-tag-id="${tag.id}" data-tag-name="${tag.name}" data-tag-description="${tagDescription}" data-namespace="${displayName}" title="${tagDescription}">
                                    <span class="tag-namespace">${displayName}:</span>
                                    ${tag.name}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });

            return html;
        }

        function renderMangaDetail(manga, chapters) {
            const content = document.getElementById('mangaDetailContent');
            content.classList.add('loading'); // 添加loading类以准备动画

            chapters.sort((a, b) => a.number - b.number);

            // 获取阅读进度
            const progress = getReadingProgress(manga.id);
            let buttonText = "开始阅读";
            let buttonChapterId = chapters[0].id;
            let buttonAction = `readManga('${manga.id}', '${chapters[0].id}', 1)`;

            if (progress) {
                // 查找进度记录中的章节是否在当前漫画章节列表中
                const progressChapter = chapters.find(chapter => chapter.id === progress.chapterId);
                if (progressChapter) {
                    buttonText = "继续阅读";
                    buttonChapterId = progress.chapterId;
                    buttonAction = `readManga('${manga.id}', '${progress.chapterId}', ${progress.pageNum || 1})`;
                }
            }

            content.innerHTML = `
                <div class="manga-header">
                    <div class="manga-cover-section">
                        <img src="/api/manga/${manga.id}/cover" alt="${manga.title}" class="manga-cover" onerror="this.src='https://placehold.co/300x450/eee/999?text=封面'">
                    </div>
                    <div class="manga-info-section">
                        <h1 class="manga-title">${manga.title}</h1>
                        <div class="manga-author">作者：${manga.author}</div>
                        <div class="manga-description">${manga.description || '暂无简介'}</div>

                        <!-- 标签显示区域 -->
                        <div class="manga-tags">
                            <div class="tags-section-title">标签</div>
                            ${renderTags(manga.tags)}
                        </div>

                        <!-- 标签详情展示区域 -->
                        <div id="tagDetailSection" class="tag-detail-section" style="display: none;">
                            <div class="tag-detail-header">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 id="selectedTagName"></h3>
                                        <p id="selectedTagDescription"></p>
                                    </div>
                                    <button id="closeTagDetail" class="close-btn" onclick="closeTagDetail()">×</button>
                                </div>
                            </div>
                            <div class="tag-manga-list">
                                <h4>相关漫画</h4>
                                <div id="tagMangaGrid" class="manga-grid"></div>
                                <div id="tagPagination" class="pagination"></div>
                            </div>
                        </div>

                        <div class="manga-actions">
                            <button class="read-button" onclick="${buttonAction}">${buttonText}</button>
                        </div>
                    </div>
                </div>
                <div class="chapters-section">
                    <h2 class="section-title">章节列表 (${chapters.length} 章)</h2>
                    <div class="chapters-grid">
                        ${chapters.map(chapter => `
                            <div class="chapter-card">
                                <div class="chapter-info">
                                    <h3>第${chapter.number}章 ${chapter.title}</h3>
                                </div>
                                <div class="chapter-actions">
                                    <button class="btn" onclick="readChapter('${manga.id}', '${chapter.id}')">阅读</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // 绑定标签点击事件
            bindTagClickEvents();
            
            // 触发动画
            setTimeout(() => {
                content.classList.remove('loading'); // 移除loading状态
                content.classList.add('loaded'); // 添加loaded状态以触发动画
                
                // 触发章节卡片动画
                setTimeout(() => {
                    const chapterCards = document.querySelectorAll('.chapter-card');
                    chapterCards.forEach(card => {
                        card.classList.add('loaded');
                    });
                }, 100);
            }, 50);
        }

        // 绑定标签点击事件
        function bindTagClickEvents() {
            const tagItems = document.querySelectorAll('.tag-item');
            tagItems.forEach(tagItem => {
                tagItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tagId = this.getAttribute('data-tag-id');
                    const tagName = this.getAttribute('data-tag-name');
                    const tagDescription = this.getAttribute('data-tag-description');

                    showTagDetails(tagId, tagName, tagDescription);
                });
            });
        }

        // 显示标签详情
        function showTagDetails(tagId, tagName, tagDescription) {
            document.getElementById('selectedTagName').textContent = tagName;
            document.getElementById('selectedTagDescription').textContent = tagDescription || `标签: ${tagName}`;
            
            const tagDetailSection = document.getElementById('tagDetailSection');
            tagDetailSection.classList.remove('show'); // 重置动画
            tagDetailSection.style.display = 'block'; // 确保元素可见
            // 强制重排
            void tagDetailSection.offsetWidth;
            // 触发动画
            tagDetailSection.classList.add('show');

            // 滚动到标签详情区域
            document.getElementById('tagDetailSection').scrollIntoView({ behavior: 'smooth' });

            // 加载具有相同标签的漫画
            loadTagManga(tagId, 1);
        }

        // 加载具有特定标签的漫画
        async function loadTagManga(tagId, page) {
            const mangaGrid = document.getElementById('tagMangaGrid');
            const paginationContainer = document.getElementById('tagPagination');

            // 显示加载状态
            mangaGrid.innerHTML = '<div class="loading">加载中...</div>';
            paginationContainer.innerHTML = '';

            try {
                const response = await fetch(`/api/manga?tag=${tagId}&page=${page}&limit=12`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                const mangaList = data.data;
                const total = data.total;

                renderTagManga(mangaList, total);
                renderTagPagination(tagId, page, data.totalPages);
            } catch (error) {
                console.error('加载标签相关漫画失败:', error);
                mangaGrid.innerHTML = '<div class="error">加载失败，请稍后重试</div>';
            }
        }

        // 渲染标签相关漫画列表
        function renderTagManga(mangaList, total) {
            const mangaGrid = document.getElementById('tagMangaGrid');
            
            if (!mangaList || mangaList.length === 0) {
                mangaGrid.innerHTML = '<div class="no-manga">暂无相关漫画</div>';
                return;
            }

            const mangaCards = mangaList.map(manga => `
                <div class="tag-manga-card" onclick="window.location.href='/manga-detail.html?id=${manga.id}'">
                    <img src="/api/manga/${manga.id}/cover" alt="${manga.title}" class="tag-manga-cover" 
                         onerror="this.src='https://placehold.co/140x180/eee/999?text=封面'">
                    <div class="tag-manga-info">
                        <div class="tag-manga-title" title="${manga.title}">${manga.title}</div>
                        <div class="tag-manga-author" title="${manga.author}">${manga.author}</div>
                    </div>
                </div>
            `).join('');

            mangaGrid.innerHTML = mangaCards;
            
            // 添加动画效果
            setTimeout(() => {
                const cards = document.querySelectorAll('#tagMangaGrid .tag-manga-card');
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add('animate');
                    }, index * 50); // 逐个延迟显示，创建渐进效果
                });
            }, 50);
        }

        // 渲染标签漫画分页
        function renderTagPagination(tagId, currentPage, totalPages) {
            const paginationContainer = document.getElementById('tagPagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // 上一页按钮
            if (currentPage > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="loadTagManga('${tagId}', ${currentPage - 1})">‹ 上一页</button>`;
            }

            // 页码按钮
            const maxVisible = 5; // 显示的页码数量
            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible - 1);
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }

            for (let i = start; i <= end; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="pagination-btn active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="pagination-btn" onclick="loadTagManga('${tagId}', ${i})">${i}</button>`;
                }
            }

            // 下一页按钮
            if (currentPage < totalPages) {
                paginationHTML += `<button class="pagination-btn" onclick="loadTagManga('${tagId}', ${currentPage + 1})">下一页 ›</button>`;
            }

            paginationContainer.innerHTML = `<div class="pagination-container">${paginationHTML}</div>`;
        }

        // 关闭标签详情
        function closeTagDetail() {
            const tagDetailSection = document.getElementById('tagDetailSection');
            tagDetailSection.classList.remove('show');
            
            // 在过渡结束后隐藏元素
            setTimeout(() => {
                if (!tagDetailSection.classList.contains('show')) {
                    tagDetailSection.style.display = 'none';
                }
            }, 400); // 等待动画完成时间
        }

        function readManga(mangaId, chapterId, pageNum = 1) {
            window.location.href = `/reader.html?manga=${mangaId}&chapter=${chapterId}&page=${pageNum}`;
        }

        function readChapter(mangaId, chapterId) {
            // 记录用户选择了这个章节，从第一页开始阅读
            setReadingProgress(mangaId, chapterId, 1);
            window.location.href = `/reader.html?manga=${mangaId}&chapter=${chapterId}`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadMangaDetail();
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"63f3b830c4a8439896885448af2cfd72","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
